jQuery(document).ready(function ($) {
    
    var $doc = $(document);

    $doc.on('click', '.super-field .super-tags li', function(){
        var $tag = $(this).data('value');
        var $field = $(this).parents('.super-field:eq(0)').find('textarea');
        $(this).parents('.super-tags:eq(0)').removeClass('active');
        var cursorPosStart = $field.prop('selectionStart');
        var cursorPosEnd = $field.prop('selectionEnd');
        var v = $field.val();
        var textBefore = v.substring(0,  cursorPosStart );
        var textAfter  = v.substring( cursorPosEnd, v.length );
        $field.val( textBefore+ $tag +textAfter );
        return false;
    });

    $doc.on('click', '.super-field .super-tags', function(){
        $(this).toggleClass('active');
    });

    $('.super-settings .super-wrapper .super-fields .super-field textarea').each(function(){
        var $tags = $('.super-settings > .super-wrapper > .super-tags').clone();
        $($tags).insertBefore($(this));
    });

    $doc.on('click','.super-settings .restore-default',function(){ 
        if(confirm(super_settings_i18n.restore_default_confirm) == true) {
            var $this = $(this);
            $this.val(super_settings_i18n.restore_default_working);
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_load_default_settings',
                },
                success: function (data) {
                    location.reload();
                },
                error: function(){
                    $('.save .message').removeClass('success').addClass('error').html(super_settings_i18n.restore_default_error);
                }
            });
        }
    });
    $doc.on('click','.super-settings .save .button',function(){ 
        var $this = $(this);
        $this.val(super_settings_i18n.save_loading);
        $('.save .message').removeClass('error').removeClass('success');
        var $data = [];
        $('.super-fields .element-field').each(function(){
            $data.push({'name':$(this).attr('name'), 'value':$(this).val()});
        });
        $.ajax({
            type: 'post',
            url: ajaxurl,
            data: {
                action: 'super_save_settings',
                data: $data,
            },
            success: function (data) {
                $this.val(super_settings_i18n.save_settings);
                $('.save .message').removeClass('error').addClass('success').html(super_settings_i18n.save_success);
            },
            error: function(){
                $('.save .message').removeClass('success').addClass('error').html(super_settings_i18n.save_error);
            }
        });
    });
    $doc.on('click','.super-tabs li',function(){
        if(!$(this).hasClass('save')){
            $('.super-tabs li').removeClass('active');
            $(this).addClass('active');
            $('.super-wrapper .super-fields').removeClass('active');
            $('.super-wrapper .super-fields:eq('+$(this).index()+')').addClass('active');
            location.hash = $(this).index();
        }
    });
    var $current_tab = window.location.hash.substring(1);
    if($current_tab!=''){
        $('.super-tabs li').removeClass('active');
        $('.super-tabs li:eq('+$current_tab+')').addClass('active');
        $('.super-wrapper .super-fields').removeClass('active');
        $('.super-wrapper .super-fields:eq('+$current_tab+')').addClass('active');
    }
    if ("onhashchange" in window) { // event supported?
        window.onhashchange = function () {
            var $current_tab = window.location.hash.substring(1);
            if($current_tab!=''){
                $('.super-tabs li').removeClass('active');
                $('.super-tabs li:eq('+$current_tab+')').addClass('active');
                $('.super-wrapper .super-fields').removeClass('active');
                $('.super-wrapper .super-fields:eq('+$current_tab+')').addClass('active');
            }
        }
    }
    else { // event not supported:
        var storedHash = window.location.hash;
        window.setInterval(function () {
            if (window.location.hash != storedHash) {
                var $current_tab = window.location.hash.substring(1);
                if($current_tab!=''){
                    $('.super-tabs li').removeClass('active');
                    $('.super-tabs li:eq('+$current_tab+')').addClass('active');
                    $('.super-wrapper .super-fields').removeClass('active');
                    $('.super-wrapper .super-fields:eq('+$current_tab+')').addClass('active');
                }
            }
        }, 100);
    }
    
});