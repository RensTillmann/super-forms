jQuery(document).ready(function ($) {
    
    var $doc = $(document);

    $doc.on('click','.super-settings .export-entries',function(){
        var $this = $(this);
        var $old_html = $this.html();
        var $type = $this.data('type');
        var $delimiter = $('input[name="delimiter"]').val();
        var $enclosure = $('input[name="enclosure"]').val();
        $this.html(super_settings_i18n.export_entries_working);
        $.ajax({
            type: 'post',
            url: ajaxurl,
            data: {
                action: 'super_export_entries',
                type: $type,
                delimiter: $delimiter,
                enclosure: $enclosure
            },
            success: function (data) {
                window.location.href = data;
            },
            error: function(){
                alert(super_settings_i18n.export_entries_error);
            },
            complete: function(){
                $this.html($old_html);
            }
        });
    });
    $doc.on('click', '.super-field .super-tags li', function(){
        var $tag = $(this).data('value');
        var $field = $(this).parents('.super-field:eq(0)').find('textarea');
        $(this).parents('.super-tags:eq(0)').removeClass('active');
        var cursorPosStart = $field.prop('selectionStart');
        var cursorPosEnd = $field.prop('selectionEnd');
        var v = $field.val();
        var textBefore = v.substring(0,  cursorPosStart );
        var textAfter  = v.substring( cursorPosEnd, v.length );
        $field.val( textBefore+ $tag +textAfter );
        return false;
    });

    $doc.on('click', '.super-field .super-tags', function(){
        $(this).toggleClass('active');
    });

    $('.super-settings .super-wrapper .super-fields .super-field textarea').each(function(){
        var $tags = $('.super-settings > .super-wrapper > .super-tags').clone();
        $($tags).insertBefore($(this));
    });

    
    $doc.on('click','.super-settings .deactivate',function(){ 
        if(confirm(super_settings_i18n.deactivate_confirm) == true) {
            var $data = [];
            $('.super-fields .element-field').each(function(){
                $data.push({'name':$(this).attr('name'), 'value':$(this).val()});
            });
            var $this = $(this);
            $this.html(super_settings_i18n.deactivate_working);
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_deactivate',
                    data: $data,
                },
                success: function (data) {
                    var data = $.parseJSON(data);
                    if((data != null) && (data.error !== 'undefined')){
                        if(data.error){
                            var $tab = $('.activation-msg').parents('.super-fields:eq(0)').index() - 1;
                            $('.super-tabs > li, .super-wrapper > .super-fields').removeClass('active');
                            $('.super-tabs li:eq('+$tab+')').addClass('active');
                            $('.super-wrapper .super-fields:eq('+$tab+')').addClass('active');
                            $('.activation-msg').html('<strong style="color:red;">'+data.msg+'</strong><br /><br /><span class="button super-button deactivate">Deactivate on current domain</span>');
                        }else{
                            $('.activation-msg').html('<strong style="color:green;">'+data.msg+'</strong>');
                        }
                    }
                },
                error: function(){
                    $('.save .message').removeClass('success').addClass('error').html(super_settings_i18n.deactivate_error);
                }
            });
        }
    });


    $doc.on('click','.super-settings .restore-default',function(){ 
        if(confirm(super_settings_i18n.restore_default_confirm) == true) {
            var $this = $(this);
            $this.val(super_settings_i18n.restore_default_working);
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_load_default_settings',
                },
                success: function (data) {
                    location.reload();
                },
                error: function(){
                    $('.save .message').removeClass('success').addClass('error').html(super_settings_i18n.restore_default_error);
                }
            });
        }
    });
    $doc.on('click','.super-settings .save .button',function(){ 
        var $this = $(this);
        $this.val(super_settings_i18n.save_loading);
        $('.save .message').removeClass('error').removeClass('success');
        var $data = [];
        $('.super-fields .element-field').each(function(){
            $data.push({'name':$(this).attr('name'), 'value':$(this).val()});
        });
        $.ajax({
            type: 'post',
            url: ajaxurl,
            data: {
                action: 'super_save_settings',
                data: $data,
            },
            success: function (data) {
                var data = $.parseJSON(data);
                if((data != null) && (data.error !== 'undefined')){
                    if(data.error){
                        var $tab = $('.activation-msg').parents('.super-fields:eq(0)').index() - 1;
                        $('.super-tabs > li, .super-wrapper > .super-fields').removeClass('active');
                        $('.super-tabs li:eq('+$tab+')').addClass('active');
                        $('.super-wrapper .super-fields:eq('+$tab+')').addClass('active');
                        $('.activation-msg').html('<strong style="color:red;">'+data.msg+'</strong>');
                    }else{
                        $('.activation-msg').html('<strong style="color:green;">'+data.msg+'</strong>');
                    }
                }
                $this.val(super_settings_i18n.save_settings);
                $('.save .message').removeClass('error').addClass('success').html(super_settings_i18n.save_success);
            },
            error: function(){
                $('.save .message').removeClass('success').addClass('error').html(super_settings_i18n.save_error);
            }
        });
    });
    $doc.on('click','.super-tabs li',function(){
        if(!$(this).hasClass('save')){
            $('.super-tabs li').removeClass('active');
            $(this).addClass('active');
            $('.super-wrapper .super-fields').removeClass('active');
            $('.super-wrapper .super-fields:eq('+$(this).index()+')').addClass('active');
            location.hash = $(this).index();
        }
    });
    var $current_tab = window.location.hash.substring(1);
    if($current_tab!=''){
        $('.super-tabs li').removeClass('active');
        $('.super-tabs li:eq('+$current_tab+')').addClass('active');
        $('.super-wrapper .super-fields').removeClass('active');
        $('.super-wrapper .super-fields:eq('+$current_tab+')').addClass('active');
    }
    if ("onhashchange" in window) { // event supported?
        window.onhashchange = function () {
            var $current_tab = window.location.hash.substring(1);
            if($current_tab!=''){
                $('.super-tabs li').removeClass('active');
                $('.super-tabs li:eq('+$current_tab+')').addClass('active');
                $('.super-wrapper .super-fields').removeClass('active');
                $('.super-wrapper .super-fields:eq('+$current_tab+')').addClass('active');
            }
        }
    }
    else { // event not supported:
        var storedHash = window.location.hash;
        window.setInterval(function () {
            if (window.location.hash != storedHash) {
                var $current_tab = window.location.hash.substring(1);
                if($current_tab!=''){
                    $('.super-tabs li').removeClass('active');
                    $('.super-tabs li:eq('+$current_tab+')').addClass('active');
                    $('.super-wrapper .super-fields').removeClass('active');
                    $('.super-wrapper .super-fields:eq('+$current_tab+')').addClass('active');
                }
            }
        }, 100);
    }

    // @since   1.0.6
    $doc.on('click','.super-settings .import-settings, .super-settings .load-default-settings',function(){
        var $method = 'import';
        var $button = $(this);
        var $settings = $('.super-export-import textarea[name="import-json"]').val();
        $button.addClass('loading');
        if($button.hasClass('load-default-settings')){
            $method = 'load-default';
        }
        $.ajax({
            type: 'post',
            url: ajaxurl,
            data: {
                action: 'super_import_settings',
                settings: $settings,
                method: $method,
            },
            success: function(data){
                $button.val(super_settings_i18n.save_settings);
                $('.save .message').removeClass('error').addClass('success').html(super_settings_i18n.save_success);
                location.reload();
            },
            error: function(){
                $('.save .message').removeClass('success').addClass('error').html(super_settings_i18n.save_error);
            },
            complete: function(){
                $button.removeClass('loading');

            }
        });
    });

});