
// Shim to add better support for .matches()
if (!Element.prototype.matches) {
    Element.prototype.matches = 
    Element.prototype.matchesSelector || 
    Element.prototype.webkitMatchesSelector ||
    Element.prototype.mozMatchesSelector ||
    Element.prototype.msMatchesSelector || 
    Element.prototype.oMatchesSelector || 
    function(s) {
        var matches = (this.document || this.ownerDocument).querySelectorAll(s),
            i = matches.length;
        while (--i >= 0 && matches.item(i) !== this) {}
        return i > -1;            
    };
}

// Define our application
const app = {

    // Equivalent for jQuery's .on() function
    delegate : function(el, evt, sel, handler) {
        el.addEventListener(evt, function(event) {
            var t = event.target;
            while (t && t !== this) {
                if (t.matches(sel)) {
                    handler.call(t, event);
                }
                t = t.parentNode;
            }
        });
    },

    // Define element edit panel events
    panel : {
        events : {
            click : [
                '.super-edit-element-panel .super-width > label',
                '.super-edit-element-panel .super-positioning > label',
                '.super-edit-element-panel .super-alignment > label',
                '.super-edit-element-panel .super-margins > label',
                '.super-edit-element-panel .super-paddings > label'
            ],
            keyup : [
                '.super-edit-element-panel .element-field',
                '.super-edit-element-panel .super-width-custom > input',
                '.super-edit-element-panel .super-custom-width input',
                '.super-edit-element-panel .super-custom-height input',
                '.super-edit-element-panel .super-margins input',
                '.super-edit-element-panel .super-paddings input'
            ],
            blur : [
                '.super-edit-element-panel .element-field',
                '.super-edit-element-panel .super-width-custom > input',
                '.super-edit-element-panel .super-custom-width input',
                '.super-edit-element-panel .super-custom-height input',
                '.super-edit-element-panel .super-margins input',
                '.super-edit-element-panel .super-paddings input'
            ]
        }
    },

    // Define methods such as getting the "current editing" element
    get : {
        editing : function(){
            return document.querySelector('.super-preview-elements .super-element.editing');
        }
    },

    // Define element methods such as updating it's json data
    element : {
        update : {
            data : function(editing){
                if(typeof editing === 'undefined'){
                    const editing = this.get.editing();
                }
                const data = editing.querySelector('textarea[name="element-data"]').value;
                console.log(data);
            }
        }
    }
};

app.delegate(document, 'click', '.super-edit-element-panel .super-positioning > label', function(event){
    
});

//delegate(document, "click", ".some_elem", function(event) {
//    this.style.border = "2px dashed orange";
//});


Object.keys(app.panel.events).forEach(function(event) {
    /*
    const elements = app.panel.events[event];
    Object.keys(elements).forEach(function(index) {
        const object = app.get.editingediting.querySelector(elements[index]);
        console.log(object);
    });
    /*
    elements.addEventListener(event, function(){
        console.log('test6');
        //app.get.editing();
    });
    /*const elements = app.panel.events[event].join(", ");
    $doc.on(event, elements, function(){
        console.log('test5');
        //var $editing = super_get_editing_element();
        //console.log('test2');
        //update_element_data($editing);
    });
    */
});

/*
// Get element field label styles
function update_element_data(editing){
    if(typeof editing === 'undefined') {
        const editing = super_get_editing_element();
    }
    const $data = $editing.children('textarea[name="element-data"]').val();
    console.log($data);
} 

Object.keys(app.panel.events).forEach(function(event) {
    const elements = app.panel.events[event].join(", ");
    $doc.on(event, elements, function(){
        console.log('test5');
        //var $editing = super_get_editing_element();
        //console.log('test2');
        //update_element_data($editing);
    });
});
*/


(function($) { // Hide scope, no $ conflict

    $(document).ready(function(){

        const $doc = $(document);

        // Get element field label styles
        function update_element_data($editing){
            if(typeof $editing === 'undefined') {
                const $editing = super_get_editing_element();
            }
            const $data = $editing.children('textarea[name="element-data"]').val();
            console.log($data);
        } 

        Object.keys(app.panel.events).forEach(function(event) {
            const elements = app.panel.events[event].join(", ");
            $doc.on(event, elements, function(){
                console.log('test5');
                //var $editing = super_get_editing_element();
                //console.log('test2');
                //update_element_data($editing);
            });
        });

        /*
        console.log(panel_events);
        $(panel_events).each(function(index,value){
            console.log(index, value);
        });
        */

        $doc.on('change click keydown keyup blur', '.super-edit-element-panel .element-field', function(){
            const $editing = super_get_editing_element();
            console.log('test2');
            update_element_data($editing);
        });

        $doc.on('change click keydown keyup blur', '.super-custom-width input, .super-custom-height input, .super-margins input, .super-paddings input, .super-margins > label, .super-paddings > label', function(){

        });

        /*
        // Update json for element after On updating label font color
        function 
        {
            "name": "option",
            "label": "test",
            "width_unit": "px",
            "label_position": "left:center:flex::px:1\/4",

            "styles" : [{
                "label" : [{
                    "font" : [{
                        "color" : "",
                        "size" : "",
                        "weight" : "",
                        "transform" : "",
                        "style" : "",
                        "decoration" : "",
                        "family" : "",
                        "line-height" : "",
                        "letter-spacing" : "",
                    }]
                }]
            }],

            "label_styles" : [{
                "font" : [{

                }]
            }],
            "email": "Option:",
            "tooltip": "123",
            "radio_items": [{
                "checked": "",
                "image": "",
                "label": "First choice1",
                "value": "first_choice"
            }, {
                "checked": "",
                "image": "",
                "label": "Second choice2",
                "value": "second_choice"
            }],
            "display": "horizontal"
        }
        */


        $doc.on('click, mousedown', '.super-preview-elements .super-element:not(.super-column) > .super-element-inner', function(e){
            e.preventDefault();
            e.stopPropagation();
        });

        // Generate first-column class for columns so we can set the correct paddings so each column has the correct width
        super_generate_first_column_classes = function($row_width, $counter){
            $(document).find('.super-preview-elements > .super-column, .super-preview-elements > .super-element.multipart > .super-element-inner > .super-column').each(function(){
                var $result = super_add_first_column_class($(this), $row_width, $counter);
                $row_width = $result.row_width;
                $counter = $result.counter;
            });
            // After done with loop show elements
            $('.super-preview-elements').addClass('rendered');
        }
        super_find_inner_columns = function($this, $row_width, $counter){
            $this.find('.super-element-inner > .super-column').each(function(){
                var $result = super_add_first_column_class($(this), $row_width, $counter);
                $row_width = $result.row_width;
                $counter = $result.counter;
            });
        }
        super_add_first_column_class = function($this, $row_width, $counter){
            if($counter==0) {
                $this.addClass('first-column');
                $counter++;
            }else{
                $this.removeClass('first-column');
            }
            var $parent = $this.parent();
            var $column_width = $this.outerWidth(true);
            var $parent_width = $parent.outerWidth(true);
            $row_width = $row_width + $column_width;
            if( $row_width > $parent_width ) {
                $this.addClass('first-column');
                $row_width = $this.outerWidth(true);
            }
            super_find_inner_columns($this, 0, 0);
            return {row_width: $row_width, counter: $counter};
        }
        super_generate_first_column_classes(0, 0);

        $doc.on('click', '.super-preview-elements .super-element-actions .move', function(){
            // only move if there are at least 2 elements
            if($('.super-preview-elements > .super-element').length>1){
                var $moving_element = $(this).parents('.super-element:eq(0)');
                if(!$moving_element.hasClass('super-moving')){
                    $('.super-preview-elements .super-moving').removeClass('super-moving');
                    $moving_element.addClass('super-moving');
                    $('.super-preview-elements').addClass('super-moving-elements');
                }else{
                    $('.super-preview-elements .super-moving').removeClass('super-moving');
                    $('.super-preview-elements').removeClass('super-moving-elements');
                }
            }
        });
        $doc.on('click', '.super-preview-elements .super-drop-before, .super-preview-elements .super-drop-inside, .super-preview-elements .super-drop-after', function(){
            var $element = $(this).parent('.super-element:eq(0)');
            var $moving = $('.super-preview-elements .super-element.super-moving');
            if($(this).hasClass('super-drop-before')){
                $element.before($moving);
            }
            if($(this).hasClass('super-drop-inside')){
                $element.children('.super-element-inner').append($moving);
            }
            if($(this).hasClass('super-drop-after')){
                $element.after($moving);
            }
            $moving.removeClass('super-moving');
            $('.super-preview-elements').removeClass('super-moving-elements');
            $('.super-preview-elements .super-drag-drop-here').removeClass('super-drag-drop-here');
            $('.super-preview-elements').find('.super-drop-before, .super-drop-inside, .super-drop-after').remove();
        });

        $doc.on('click','.super-element > .super-element-header > .resize > span',function(){
            var $editing = $(this).parents('.super-element:eq(0)');
            var $data = $editing.children('textarea[name="element-data"]').val();
            var $data = JSON.parse($data);
            var $size = $data.size;
            if( typeof $editing.attr('data-size') !== 'undefined' ){
                var $size = $editing.attr('data-size');
            }
            var $sizes = {
                '1/1':'super_one_full',
                '4/5':'super_four_fifth',
                '3/4':'super_three_fourth',
                '2/3':'super_two_third',
                '3/5':'super_three_fifth',
                '1/2':'super_one_half',
                '2/5':'super_two_fifth',
                '1/3':'super_one_third',
                '1/4':'super_one_fourth',
                '1/5':'super_one_fifth'};
            var $keys = ['1/1','4/5','3/4','2/3','3/5','1/2','2/5','1/3','1/4','1/5'];
            var $start = $size;
            var $next = $keys[($.inArray($start, $keys) + 1) % $keys.length];
            var $prev = $keys[($.inArray($start, $keys) - 1 + $keys.length) % $keys.length];
            $editing.css('width','');
            delete $data.width;
            $editing.attr('data-width','');
            if($(this).hasClass('smaller')){
                if($size=='1/5'){
                    return false;
                }
                $editing.attr('data-size',$next);
                $editing.removeClass($sizes[$start]).addClass($sizes[$next]);
                $editing.children('.super-element-header').find('.resize > .current').html($next);
                $data.size = $next;
            }
            if($(this).hasClass('bigger')){
                if($size=='1/1'){
                    return false;
                }
                $editing.attr('data-size',$prev);
                $editing.removeClass($sizes[$start]).addClass($sizes[$prev]);
                $editing.children('.super-element-header').find('.resize > .current').html($prev);
                $data.size = $prev;
            }
            $editing.children('textarea[name="element-data"]').val(JSON.stringify($data));
            SUPER.init_drag_and_drop();
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
            super_generate_first_column_classes(0, 0);
        });

        $doc.on('click', '.super-custom-width .super-size > li', function(){
            var $this = $(this);
            var $parent = $this.parent();
            var $prev_size = $parent.children('.active').text();
            $parent.children().removeClass('active');
            $this.addClass('active');
            var $editing = super_get_editing_element();
            $this.parents('.super-custom-width:eq(0)').find('input[name="width"]').val('');
            var $size = $this.text();
            var $sizes = {
                '1/1':'super_one_full',
                '4/5':'super_four_fifth',
                '3/4':'super_three_fourth',
                '2/3':'super_two_third',
                '3/5':'super_three_fifth',
                '1/2':'super_one_half',
                '2/5':'super_two_fifth',
                '1/3':'super_one_third',
                '1/4':'super_one_fourth',
                '1/5':'super_one_fifth'};
            $editing.attr('data-size', $size);

            $editing.removeClass($sizes[$prev_size]).addClass($sizes[$size]).css('width','');
            $editing.children('.super-element-header').find('.resize > .current').html($size);

            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

            // Reposition Edit Element Panel when height of editing element is changed
            SUPER.reposition_edit_element_panel(undefined, $editing);

        });

        $doc.on('change click keydown keyup blur', '.super-custom-width input, .super-custom-height input, .super-margins input, .super-paddings input, .super-margins > label, .super-paddings > label', function(){
            var $editing = super_get_editing_element();
            var $inner = $editing.children('.super-element-inner');
            var $tag = $editing.attr('data-shortcode-tag');
            var $parent = $(this).parent();
            var $parents = $(this).parents('.super-padding-margin:eq(0)');

            var $order = ['top', 'right', 'bottom', 'left'];
            var $margins = []
            var $margins_css = [];
            var $paddings_css = [];
            var $paddings = [];
            var $radius = [];
            var $radius_css = [];
            $.each($order, function($k, $v){
                var $value = $parents.find('input[name="'+$v+'_margin"]').val()
                if($value=='') $value = '0';
                if( ($value.toLowerCase().indexOf('px') != -1) && ($value.indexOf('%') != -1) ) {
                    $margins[$k] = $value.replace('px','').trim();
                    $margins_css[$k] = $margins[$k]+'px';
                }else{
                    if( $value.indexOf('%') != -1 ) {
                        $margins[$k] = $value.replace('%','').trim()+'%';
                        $margins_css[$k] = $margins[$k];
                    }else{
                        $margins[$k] = $value.trim();
                        $margins_css[$k] = $margins[$k]+'px';
                    }
                }

                var $value = $parents.find('input[name="'+$v+'_padding"]').val()
                if($value=='') $value = '0';
                if( ($value.toLowerCase().indexOf('px') != -1) && ($value.indexOf('%') != -1) ) {
                    $paddings[$k] = $value.replace('px','').trim();
                    $paddings_css[$k] = $paddings[$k]+'px';
                }else{
                    if( $value.indexOf('%') != -1 ) {
                        $paddings[$k] = $value.replace('%','').trim()+'%';
                        $paddings_css[$k] = $paddings[$k];
                    }else{
                        $paddings[$k] = $value.trim();
                        $paddings_css[$k] = $paddings[$k]+'px';
                    }
                }

                if($v=='top'){
                    var $name = 'top_left';
                }else if($v=='right'){
                    var $name = 'top_right';
                }else if($v=='bottom'){
                    var $name = 'bottom_right';
                }else if($v=='left'){
                    var $name = 'bottom_left';
                }
                var $value = $parents.find('input[name="'+$name+'_radius"]').val()
                if($value=='') $value = '0';
                if( ($value.toLowerCase().indexOf('px') != -1) && ($value.indexOf('%') != -1) ) {
                    $radius[$k] = $value.replace('px','').trim();
                    $radius_css[$k] = $radius[$k]+'px';
                }else{
                    if( $value.indexOf('%') != -1 ) {
                        $radius[$k] = $value.replace('%','').trim()+'%';;
                        $radius_css[$k] = $radius[$k];
                    }else{
                        $radius[$k] = $value.trim();
                        $radius_css[$k] = $radius[$k]+'px';
                    }
                }

            });

            var $final_radius_css = '';
            var $identical = !!$radius_css.reduce(function(a, b){ 
                return (a === b) ? a : NaN; 
            });
            if($identical){
                if($radius_css[0]!=0){
                    $final_radius_css += '-webkit-border-radius: '+$radius_css[0]+';';
                    $final_radius_css += '-moz-border-radius: '+$radius_css[0]+';';
                    $final_radius_css += 'border-radius: '+$radius_css[0]+';';
                }
            }else{
                $final_radius_css += '-webkit-border-top-left-radius: '+$radius_css[0]+';';
                $final_radius_css += '-moz-border-radius-topleft: '+$radius_css[0]+';';
                $final_radius_css += 'border-top-left-radius: '+$radius_css[0]+';';

                $final_radius_css += '-webkit-border-top-right-radius: '+$radius_css[1]+';';
                $final_radius_css += '-moz-border-radius-topright: '+$radius_css[1]+';';
                $final_radius_css += 'border-top-right-radius: '+$radius_css[1]+';';
                
                $final_radius_css += '-webkit-border-bottom-right-radius: '+$radius_css[2]+';';
                $final_radius_css += '-moz-border-radius-bottomright: '+$radius_css[2]+';';
                $final_radius_css += 'border-bottom-right-radius: '+$radius_css[2]+';';

                $final_radius_css += '-webkit-border-bottom-left-radius: '+$radius_css[3]+';';
                $final_radius_css += '-moz-border-radius-bottomleft: '+$radius_css[3]+';';
                $final_radius_css += 'border-bottom-left-radius: '+$radius_css[3]+';';
            }
            var $margins = $margins.join(" ");
            var $margins_css = $margins_css.join(" ");
            var $paddings = $paddings.join(" ");
            var $paddings_css = $paddings_css.join(" ");
            var $radius = $radius.join(" ");
            var $height = $parents.find('input[name="height"]').val();
            var $width = $parents.find('input[name="width"]').val();
            var $width_unit = $parents.find('input[name="width_unit"]').val();
            if( $(this).prop("tagName")=='LABEL' ) {
                if( $parent.hasClass('active') ) {
                    // Disable custom margin
                    if( $parent.hasClass('super-margins') ) {
                        if( $tag=='column' ) {
                            $editing.removeClass('super-custom-margin');
                            $editing.attr('data-custom-margin', '');
                            $editing.css('margin', '');
                            $parents.find('input[name="margin"]').val('');
                        }
                    }
                    // Disable custom padding
                    if( $parent.hasClass('super-paddings') ) {
                        if( $tag=='column' ) {
                            $editing.removeClass('super-custom-padding');
                            $editing.attr('data-custom-padding', '');
                            $inner.css('padding', '');
                            $parents.find('input[name="padding"]').val('');
                        }
                    }
                }else{
                    // Enable custom margin
                    if( $parent.hasClass('super-margins') ) {
                        if( $tag=='column' ) {
                            $editing.addClass('super-custom-margin');
                            $editing.attr('data-custom-margin', $margins);
                            $editing.css('margin', $margins_css);
                            $parents.find('input[name="margin"]').val($margins);
                        }
                    }
                    // Enable custom padding
                    if( $parent.hasClass('super-paddings') ) {
                        if( $tag=='column' ) {
                            $editing.addClass('super-custom-padding');
                            $editing.attr('data-custom-padding', $paddings);
                            $inner.css('padding', $paddings_css);
                            $parents.find('input[name="padding"]').val($paddings);
                        }
                    }
                    
                }
                $parent.toggleClass('active');
            }else{
                if( $tag=='column' ) {
                    // Enable custom margin
                    if( $parent.hasClass('super-margins') ) {
                        $editing.addClass('super-custom-margin');
                        $editing.attr('data-custom-margin', $margins);
                        $editing.css('margin', $margins_css);
                        $parents.find('input[name="margin"]').val($margins);
                    }
                    // Enable custom padding
                    if( $parent.hasClass('super-paddings') ) {
                        $editing.addClass('super-custom-padding');
                        $editing.attr('data-custom-padding', $paddings);
                        $inner.css('padding', $paddings_css);
                        $parents.find('input[name="padding"]').val($paddings);
                    }
                    // Add border radius if not empty or zero
                    if($final_radius_css!=''){
                        var $radius_css = $final_radius_css.split(';');
                        $.each($radius_css, function($k, $v){
                            if($v!=''){
                                var $css = $v.split(':');
                                $editing.css($css[0], $css[1]);
                            }
                        });
                        $parents.find('input[name="radius"]').val($radius);
                    }
                }

                if( ($width!='') && ($width!=0) ) {
                    if( $tag=='column' ) {
                        $editing.css('width', $width+$width_unit);
                    }
                }else{
                    if( $tag=='column' ) {
                        $editing.css('width', '');
                    }           
                }
                if( ($height!='') && ($height!=0) ) {
                    if( $tag=='column' ) {
                        $editing.css('height', $height);
                    }
                }else{
                    if( $tag=='column' ) {
                        $editing.css('height', '');
                    }
                }
            }

            if( ($parent.hasClass('super-margins')) || ($parent.hasClass('super-paddings')) || ($parent.hasClass('super-custom-width')) || ($parent.hasClass('super-custom-height')) ) {
                if(!$parents.children('.super-margins').hasClass('active')) $margins = '';
                if(!$parents.children('.super-paddings').hasClass('active')) $paddings = '';
            }

            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

            // Reposition Edit Element Panel when height of editing element is changed
            SUPER.reposition_edit_element_panel();

        });

        $doc.on('change keydown keyup blur click', '.super-edit-element-panel .element-field, .super-edit-element-panel input, .super-edit-element-panel select', function(e){
            if( !$('.super-edit-element-panel.super-active').hasClass('super-active') ) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            var $this = $(this);
            var $name = $this.attr('name');
            var $parent = $this.parent();
            var $value = $this.val();
            var $editing = super_get_editing_element();
            var $tag = $editing.attr('data-shortcode-tag');
            
            if($this.hasClass('element-field')){

                if( ($tag=='checkbox') || ($tag=='radio') ) {
                    if($name=='display'){
                        if($value=='vertical'){
                            $editing.find('.super-shortcode').removeClass('display-horizontal').addClass('display-vertical');
                        }else{
                            $editing.find('.super-shortcode').removeClass('display-vertical').addClass('display-horizontal');
                        }
                    }
                }
                
                // Update background styles
                if($tag=='column'){
                    if($name=='bg_size'){
                        if($value=='custom'){
                            $this.next().show();
                            $value = $this.next().val();
                        }else{
                            $this.next().hide();
                        }
                        $editing.css('background-size', $value);
                    }
                    if($name=='bg_size_custom'){
                        if( ($value.toLowerCase().indexOf('px') != -1) && ($value.indexOf('%') != -1) ) {
                            $value = $value.replace('px','').trim()+'px';
                        }else{
                            if( $value.indexOf('%') != -1 ) {
                                $value = $value.replace('%','').trim()+'%';
                            }else{
                                $value = $value.replace('px','').trim()+'px';
                            }
                        }
                        $editing.css('background-size', $value);
                    }
                    if($name=='bg_repeat'){
                        $editing.css('background-repeat', $value);
                    }
                    if($name=='bg_position'){
                        $editing.css('background-position', $value);
                    }
                }

                // Add, update or delete field label
                if($name=='label'){
                    var $element = $editing.find('.super-label');
                    if($value==''){
                        $element.remove();
                    }else{
                        // Allow to enter an empty space to add the label to give some spacing if the user wants to
                        if($value===' '){
                            $value = '&nbsp;';
                        }
                        // If the label already exists, just add the value as it's HTML
                        if($element.length){
                            $element.html($value);
                        }else{
                            // If it doesn't exist yet add the wrapper HTML also
                            if($editing.find('.super-label-description').length){
                                $('<div class="super-label">'+$value+'</div>').prependTo($editing.find('.super-label-description'));
                            }else{
                                $('<div class="super-label-description"><div class="super-label">'+$value+'</div></div>').insertBefore($editing.find('.super-field-wrapper'));
                            }
                        }
                    }
                }

                // Add, update or delete field placeholder
                if($name=='placeholder'){
                    $editing.find('.super-shortcode-field').attr('placeholder', $value);
                }

                // Add, update or delete field description
                if($name=='description'){
                    var $element = $editing.find('.super-description');
                    if($value==''){
                        $element.remove();
                    }else{
                        if($value===' '){
                            $value = '&nbsp;';
                        }
                        if($element.length){
                            $element.html($value);
                        }else{
                            // If it doesn't exist yet, add the wrapper HTML also
                            if($editing.find('.super-label-description').length){
                                $('<div class="super-description">'+$value+'</div>').appendTo($editing.find('.super-label-description'));
                            }else{
                                $('<div class="super-label-description"><div class="super-description">'+$value+'</div></div>').insertBefore($editing.find('.super-field-wrapper'));
                            }
                        }
                    }
                }

                // Add, update or delete tooltip and
                if($name=='tooltip'){
                    // Only if tooltip was already intitialized
                    var $element = $editing.find('.super-shortcode.tooltipstered');
                    if($value==''){
                        $element.tooltipster('disable');
                    }else{
                        $element.tooltipster('content', $value);
                        $element.tooltipster('enable');
                    }
                }

            }else{
                if( ($tag=='checkbox') || ($tag=='radio') ) {
                    var $index = $this.parents('.super-multi-items:eq(0)').index()-1;
                    var $item = $editing.find('.super-field-wrapper').children('label:eq('+($index)+')');
                    var $image = $item.children('.image');

                    if($name=='bg_size'){
                        if($value=='custom'){
                            $this.next().show();
                            $value = $this.next().val();
                        }else{
                            $this.next().hide();
                        }
                        $image.css('background-size', $value);
                    }
                    if($name=='bg_size_custom'){
                        if( ($value.toLowerCase().indexOf('px') != -1) && ($value.indexOf('%') != -1) ) {
                            $value = $value.replace('px','').trim()+'px';
                        }else{
                            if( $value.indexOf('%') != -1 ) {
                                $value = $value.replace('%','').trim()+'%';
                            }else{
                                $value = $value.replace('px','').trim()+'px';
                            }
                        }
                        $image.css('background-size', $value);
                    }
                    if($name=='bg_repeat'){
                        $image.css('background-repeat', $value);
                    }
                    if($name=='bg_position'){
                        $image.css('background-position', $value);
                    }
                    if( ($name=='width') || ($name=='height') ) {
                        if($name=='width'){
                            if($value==''){
                                $item.find('img').css('width', '');
                            }else{
                                $item.find('img').css('width', $value.trim()+'px');
                            }
                        }
                        if($name=='height'){
                            if($value==''){
                                $item.find('img').css('height', '');
                            }else{
                                $item.find('img').css('height', $value.trim()+'px');
                            }
                        }
                    }
                }

            }


            // Prepare multi-items options
            $this.parents('.super-edit-element-panel:eq(0)').find('.multi-items').each(function(){
                SUPER.update_multi_items($(this));
            });

            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

            // Multi item field
            if($parent.hasClass('super-multi-items')){
                var $index = $parent.index()-1;
                var $item = $editing.find('.super-field-wrapper').children('label:eq('+($index)+')');
                
                if( ($tag=='checkbox') || ($tag=='radio') ) {
                    var $image = $item.children('.image');

                    if($name='label'){

                        var $data = $editing.children('textarea[name="element-data"]').val();
                        $data = JSON.parse($data);
                        if($this.parent().hasClass('super-multi-items')){
                            if($tag=='checkbox'){
                                $data = $data.checkbox_items[$this.parent().index()-1];
                            }
                            if($tag=='radio'){
                                $data = $data.radio_items[$this.parent().index()-1];
                            }
                        }

                        var $image_url = $image.css('background-image');
                        var $item_html = '';
                        if(typeof $image_url !== 'undefined'){
                            $image_url = $image_url.replace('url(','').replace(')','').replace(/\"/gi, "");
                            $item_html += '<div class="image" style="background-image:url('+$image_url+');" >';
                            $item_html += '<img src="'+$image_url+'"';
                            var $item_styles = '';
                            if( typeof $data.width !== 'undefined' ) {
                                if( ($data.width.toLowerCase().indexOf('px') != -1) && ($data.width.indexOf('%') != -1) ) {
                                    $data.width = $data.width.replace('px','').trim()+'px';
                                }else{
                                    if( $data.width.indexOf('%') != -1 ) {
                                        $data.width = $data.width.replace('%','').trim()+'%';
                                    }else{
                                        $data.width = $data.width.replace('px','').trim()+'px';
                                    }
                                }
                                $item_styles += 'width:'+$data.width+';';
                            }
                            if( typeof $data.height !== 'undefined' ) {
                                if( ($data.height.toLowerCase().indexOf('px') != -1) && ($data.height.indexOf('%') != -1) ) {
                                    $data.height = $data.height.replace('px','').trim()+'px';
                                }else{
                                    if( $data.height.indexOf('%') != -1 ) {
                                        $data.height = $data.height.replace('%','').trim()+'%';
                                    }else{
                                        $data.height = $data.height.replace('px','').trim()+'px';
                                    }
                                }
                                $item_styles += 'height:'+$data.height+';';
                            }
                            if($item_styles!=''){
                                $item_html += ' style="'+$item_styles+'"';
                            }
                            $item_html += '>';
                            $item_html += '</div>';
                        }
                        if( $tag=='checkbox') {
                            $item_html += '<input type="checkbox" value="'+$data.value+'">';
                        }
                        if( $tag=='radio') {
                            $item_html += '<input type="radio" value="'+$data.value+'">';
                        }
                        $item_html += '<span class="super-item-label">'+$data.label+'</span>';
                        $item.html($item_html);
                    }
                    if($name=='bg_size'){
                        if($value=='custom'){
                            $this.next().show();
                            $value = $this.next().val();
                        }else{
                            $this.next().hide();
                        }
                        $image.css('background-size', $value);
                    }
                    if($name=='bg_size_custom'){
                        if( ($value.toLowerCase().indexOf('px') != -1) && ($value.indexOf('%') != -1) ) {
                            $value = $value.replace('px','').trim()+'px';
                        }else{
                            if( $value.indexOf('%') != -1 ) {
                                $value = $value.replace('%','').trim()+'%';
                            }else{
                                $value = $value.replace('px','').trim()+'px';
                            }
                        }
                        $image.css('background-size', $value);
                    }
                    if($name=='bg_repeat'){
                        $image.css('background-repeat', $value);
                    }
                    if($name=='bg_position'){
                        $image.css('background-position', $value);
                    }
                    if( ($name=='width') || ($name=='height') ) {
                        if($name=='width'){
                            if($value==''){
                                $item.find('img').css('width', '');
                            }else{
                                $item.find('img').css('width', $value.trim()+'px');
                            }
                        }
                        if($name=='height'){
                            if($value==''){
                                $item.find('img').css('height', '');
                            }else{
                                $item.find('img').css('height', $value.trim()+'px');
                            }
                        }
                    }
                }

                /*
                if($this.attr('type')=='radio'){
                    if($tag=='checkbox'){
                        if($(this).attr('data-prev')=='false'){
                            $item.removeClass('super-selected');
                        }else{
                            $item.addClass('super-selected');
                        }
                    }
                    if($tag=='radio'){
                        var $wrapper = $editing.find('.super-field-wrapper');
                        if($(this).attr('data-prev')=='false'){
                            $wrapper.children('label').removeClass('super-selected');
                        }else{
                            $wrapper.children('label').removeClass('super-selected');
                            $item.addClass('super-selected');
                        }
                    }
                }else{
                    //var $label = $parent.children('input[name="label"]').val();
                    //var $value = $parent.children('input[name="value"]').val();
                    //$item.html('<input type="radio" value="'+$value+'">'+$label);
                }
                */
            }

            // Reposition Edit Element Panel when height of editing element is changed
            SUPER.reposition_edit_element_panel();

        });

        super_get_editing_element = function(){
            return $('.super-preview-elements .super-element.editing');
        }

        super_set_label_width = function($label, $parent, $values){
            var $width = $parent.find('input[name="width"]').val();
            var $width_unit = $parent.find('input[name="width_unit"]').val();
            if(typeof $width_unit === 'undefined') $width_unit = 'px';
            if( ($width_unit!='px') && ($width_unit!='%') && ($width_unit!='em') && ($width_unit!='rem') ) {
                $width_unit = 'px';
            }
            if( ($width!='') && ($width!=0) ) {
                $label.css('width', $width+$width_unit);
            }else{
                $label.css('width', '');
            }
        }
        super_get_label_positioning_values = function($this, $values){
            if(typeof $this !== 'undefined'){
                var $field = $this.parents('.field:eq(0)').children('input[type="hidden"]');
                var $value = $field.val();
                var $values = $value.split(':');
            }
            if(typeof $values[0] === 'undefined') $values[0] = 'top';
            if(typeof $values[1] === 'undefined') $values[1] = 'left';
            if(typeof $values[2] === 'undefined') $values[2] = 'auto';
            if(typeof $values[3] === 'undefined') $values[3] = '';
            if(typeof $values[4] === 'undefined') $values[4] = 'px';
            if(typeof $values[5] === 'undefined') $values[5] = '1/2';
            return $values;
        }

        $doc.on('click','.super-edit-element-panel .super-flex-size > li',function(){
            var $this = $(this);
            var $parent = $this.parent();
            var $prev_size = $parent.children('.active').text();
            $parent.children('li').removeClass('active');
            $this.addClass('active');
            var $size = $this.text();
            var $editing = super_get_editing_element();
            var $shortcode = $editing.find('.super-shortcode');
            var $label = $shortcode.children('.super-label-description');
            var $sizes = {
                '1/1':'super_one_full',
                '4/5':'super_four_fifth',
                '3/4':'super_three_fourth',
                '2/3':'super_two_third',
                '3/5':'super_three_fifth',
                '1/2':'super_one_half',
                '2/5':'super_two_fifth',
                '1/3':'super_one_third',
                '1/4':'super_one_fourth',
                '1/5':'super_one_fifth'};
            $shortcode.removeClass($sizes[$prev_size]).addClass($sizes[$size]);

            // Update the setting value
            $values = super_get_label_positioning_values($this);
            $values[5] = $size;
            var $field = $this.parents('.field:eq(0)').children('input[type="hidden"]');
            $field.val($values.join(':'));

            // Update element data
            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());

            // Update form code
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

        });

        $doc.on('click','.super-edit-element-panel .super-width > label, .super-edit-element-panel .super-positioning > label, .super-edit-element-panel .super-alignment > label, .super-edit-element-panel .super-width > label',function(){
            var $this = $(this);
            var $parent = $(this).parent();
            var $editing = super_get_editing_element();
            var $element = $editing.find('.super-shortcode');
            var $label = $element.children('.super-label-description');
            var $field = $this.parents('.field:eq(0)');

            $parent.children('label').removeClass('active');
            var $classes = $(this)[0].className.split(/\s+/);
            var $class = $classes[0];
            $this.addClass('active');
            $values = super_get_label_positioning_values($this);
            var $flex_size = $('.super-flex-size > li.active').text();
            var $sizes = {
                '1/1':'super_one_full',
                '4/5':'super_four_fifth',
                '3/4':'super_three_fourth',
                '2/3':'super_two_third',
                '3/5':'super_three_fifth',
                '1/2':'super_one_half',
                '2/5':'super_two_fifth',
                '1/3':'super_one_third',
                '1/4':'super_one_fourth',
                '1/5':'super_one_fifth'};

            if($parent.hasClass('super-positioning')){
                $values[0] = $class;

                // Check if we need to change the Label positioning in the HTML
                if( ($class=='top') || ($class=='left') ) {
                    // Make sure the element is above the field, if not append it before the field wrapper
                    if($label.index() > $element.children('.super-field-wrapper').index()){
                        $element.children('.super-field-wrapper').before($label);
                    }
                }
                if( ($class=='bottom') || ($class=='right') ) {
                    // Make sure the element is below the field, if not append it after the field wrapper
                    if($label.index() < $element.children('.super-field-wrapper').index()){
                        $element.children('.super-field-wrapper').after($label);
                    }
                }
                if($class=='left' || $class=='right'){
                    if($values[2]=='flex'){
                        $element.addClass($sizes[$flex_size]);
                        $field.children('.super-flex-size').css('display','block');
                    }
                    if($values[2]=='auto'){
                        $label.css('width','');
                    }
                    if($values[2]=='fixed'){
                        super_set_label_width($label, $field.find('.super-width .super-width-custom'));
                    }
                    $('.super-edit-element-panel .super-width').css('display','block');
                }else{
                    $element.removeClass($sizes[$flex_size]);
                    $label.css('width','');
                    $('.super-edit-element-panel .super-width').css('display','none');
                    $field.children('.super-flex-size').css('display','none');
                }
            }
            if($parent.hasClass('super-alignment')){
                $values[1] = $class;
            }
            if($parent.hasClass('super-width')){
                $values[2] = $class;
                if($class=='auto'){
                    $label.css('width','');
                }
                if($class=='fixed'){
                    super_set_label_width($label, $parent);
                    $parent.children('.super-width-custom').css('display','block');
                }else{
                    $parent.children('.super-width-custom').css('display','none');
                }
                if($class=='flex'){
                    $label.css('width','');
                    $element.addClass($sizes[$flex_size]);
                    $field.children('.super-flex-size').css('display','block');
                }else{
                    $element.removeClass($sizes[$flex_size]);
                    $field.children('.super-flex-size').css('display','none');
                }
            }
            $element.removeClass(function (index, className){
                return (className.match(/(^|\s)super-label-\S+/g) || []).join(' ');
            });
            $element.addClass('super-label-'+$values[0]+'-'+$values[1]);

            // Reposition Edit Element Panel when height of editing element is changed
            SUPER.reposition_edit_element_panel(undefined, $element);

            // Update the setting value
            var $field = $field.children('input[type="hidden"]');
            $field.val($values.join(':'));
            
            // Update element data
            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());

            // Update form code
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

        });

        
        $doc.on('change click keydown keyup blur', '.super-width-custom input', function(){
            var $this = $(this);
            var $editing = super_get_editing_element();
            var $inner = $editing.children('.super-element-inner');
            var $parents = $this.parents('.super-width-custom:eq(0)');
            var $label = $editing.find('.super-label-description');
            var $width = $parents.find('input[name="width"]').val();
            var $width_unit = $parents.find('input[name="width_unit"]').val();
            super_set_label_width($label, $parents);

            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

            // Reposition Edit Element Panel when height of editing element is changed
            SUPER.reposition_edit_element_panel(undefined, $editing);

            // Update the setting value
            $values = super_get_label_positioning_values($this);
            $values[3] = $width;
            $values[4] = $width_unit;
            var $field = $this.parents('.field:eq(0)').children('input[type="hidden"]');
            $field.val($values.join(':'));
        });

        $doc.on('click','.super-highlighted, .super-element-actions .edit',function(e){          
            if( ($(e.target).parents('.super-elements:eq(0)').length) ||
                ($(e.target).parent().hasClass('super-title')) ||
                ($(e.target).parent('.super-element-header').length) || 
                (($(e.target).parents('.super-element-actions:eq(0)').length) && ($(e.target).parents('.super-element-actions:eq(0)'))) ||
                (($(e.target).parents('.resize:eq(0)').length) && ($(e.target).parents('.resize:eq(0)'))) ) {
                    if(!$(this).hasClass('edit')) {
                        return false;
                    }
            }
            
            if($(this).hasClass('super-element')){
                var $parent = $(this);
            }else{
                var $parent = $(this).parents('.super-element:eq(0)');
            }

            var $editing = super_get_editing_element();
            var $edit_panel = $('.super-edit-element-panel');
            if($parent.hasClass('editing')){
                $edit_panel.addClass('super-active');
                return false;
            }else{
                // Different element editing
                if($editing.length){
                    $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
                    SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
                }
            }

            super_get_editing_element().removeClass('editing');
            $parent.addClass('editing');
            $(this).parents('.super-element').each(function(){
                $(this).addClass('editing-inner');
            });
            $('.super-preview-elements').addClass('editing-element');
            SUPER.reposition_edit_element_panel();
            var $options = $parent.children('textarea[name="element-options"]').val();
            var $data = $parent.children('textarea[name="element-data"]').val();
            var $html = SUPER.generate_element_settings($options, $data);
            $edit_panel.html($html);
            SUPER.init_previously_created_fields();
            SUPER.init_slider_field();
            SUPER.init_tooltips();
            SUPER.init_image_browser();
            SUPER.init_color_pickers();
            SUPER.init_field_filter_visibility();
            setTimeout(function(){
                $edit_panel.addClass('super-active');
            },5);
        });

        $doc.on('click', '.super-edit-element-panel .super-multi-items .super-add-item', function(){
            var $this = $(this);
            var $parent = $this.parents('.super-multi-items:eq(0)');
            var $label = super_get_editing_element().find('.super-field-wrapper').children('label:eq('+($parent.index()-1)+')');
            var $new_label = $label.clone();

            var $fields = {};
            $parent.find('select').each(function(){
                $fields[$(this).attr('name')] = $(this).val();
            });

            var $item = $parent.clone();
            $item.find('select').each(function(){
                $(this).val($fields[$(this).attr('name')]);
            });
            
            $new_label.insertAfter($label);
            var $item = $item.insertAfter($parent);

            $item.find('.initialized').removeClass('initialized');
            $item.find('input[type="radio"]').prop('checked', false);

            var $absolute_parent = $parent.parents('.multi-items:eq(0)');
            if($absolute_parent.find('.super-multi-items').length > 1){
                $absolute_parent.find('.delete').css('visibility','');
            }else{
                $absolute_parent.find('.delete').css('visibility','hidden');
            }
            if(!$parent.hasClass('super-conditional-item')){
                SUPER.init_image_browser();
            }
            SUPER.reposition_edit_element_panel();

        });
        $doc.on('click','.super-multi-items .delete',function(){
            var $this = $(this);
            var $parent = $this.parents('.field-input:eq(0)');
            if($parent.find('.super-multi-items').length <= 2){
                $parent.find('.delete').css('visibility','hidden');
            }else{
                $parent.find('.delete').css('visibility','');
            }
            super_get_editing_element().find('.super-field-wrapper').children('label:eq('+($this.parent().index()-1)+')').remove();
            $(this).parent().remove();
            SUPER.reposition_edit_element_panel();
        });
        $doc.on('change click blur keyup keydown focus', '.super-multi-items *',function(){
            SUPER.update_multi_items($(this).parents('.multi-items:eq(0)'));
        });
        $doc.on('click','.super-multi-items .sorting span.up i',function(){
            var $parent = $(this).parents('.field-input:eq(0)');
            var $count = $parent.find('.super-multi-items').length;
            if($count>1){
                var $this = $(this).parents('.super-multi-items:eq(0)');
                var $prev = $this.prev();
                var $index = $this.index();
                var $editing = super_get_editing_element();
                if($index>0){
                    var $current = $editing.find('.super-field-wrapper > label:eq('+($index-1)+')');
                    var $editing_prev = $current.prev();
                    $current.insertBefore($editing_prev);
                    $this.insertBefore($prev);
                }else{
                    var $current = $editing.find('.super-field-wrapper > label:eq(0)');
                    $current.insertAfter( $editing.find('.super-field-wrapper > label').last());
                    $this.insertAfter($parent.find('.super-multi-items').last());
                }
            }

            // Prepare multi-items options
            $(this).parents('.super-edit-element-panel:eq(0)').find('.multi-items').each(function(){
                SUPER.update_multi_items($(this));
            });
            
            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

        });
        $doc.on('click','.super-multi-items .sorting span.down i',function(){
            var $parent = $(this).parents('.field-input:eq(0)');
            var $count = $parent.find('.super-multi-items').length;
            if($count>1){
                var $this = $(this).parents('.super-multi-items:eq(0)');
                var $next = $this.next();
                var $index = $this.index();
                var $editing = super_get_editing_element();
                if($index == $count){
                    var $current = $editing.find('.super-field-wrapper > label:eq('+($index-1)+')');
                    $current.insertBefore($editing.find('.super-field-wrapper > label').first());
                    $this.insertBefore($parent.find('.super-multi-items').first());
                }else{
                    var $current = $editing.find('.super-field-wrapper > label:eq('+($index-1)+')');
                    $current.insertAfter($current.next());
                    $this.insertAfter($next);
                }
            }

            // Prepare multi-items options
            $(this).parents('.super-edit-element-panel:eq(0)').find('.multi-items').each(function(){
                SUPER.update_multi_items($(this));
            });

            var $editing = super_get_editing_element();
            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

        });
        $doc.on('click','.super-multi-items input[type="checkbox"]',function(){
            var $prev = $(this).attr('data-prev');
            var $index = $(this).parent().index()-1;
            var $editing = super_get_editing_element();
            var $current = $editing.find('.super-field-wrapper > label:eq('+($index)+')');
            if($prev=='true'){
                $current.removeClass('super-selected');
                $(this).prop('checked', false).attr('data-prev','false');
            }else{
                $current.addClass('super-selected');
                $(this).prop('checked', true).attr('data-prev','true');
            }

            // Prepare multi-items options
            $(this).parents('.super-edit-element-panel:eq(0)').find('.multi-items').each(function(){
                SUPER.update_multi_items($(this));
            });

            var $editing = super_get_editing_element();
            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

        });
        $doc.on('click','.super-multi-items input[type="radio"]',function(){
            var $prev = $(this).attr('data-prev');
            var $index = $(this).parent().index()-1;
            var $editing = super_get_editing_element();
            var $current = $editing.find('.super-field-wrapper > label:eq('+($index)+')');
            $editing.find('.super-field-wrapper > label').removeClass('super-selected');
            $(this).parents('.field-input:eq(0)').find('input[type="radio"]').prop('checked',false).attr('data-prev','false');
            if($prev=='true'){
                $(this).prop('checked', false).attr('data-prev','false');
            }else{
                $current.addClass('super-selected');
                $(this).prop('checked', true).attr('data-prev','true');
            }

            // Prepare multi-items options
            $(this).parents('.super-edit-element-panel:eq(0)').find('.multi-items').each(function(){
                SUPER.update_multi_items($(this));
            });

            var $editing = super_get_editing_element();
            $editing.children('textarea[name="element-data"]').val(SUPER.get_current_editing_fields());
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);

        });
        $doc.on('click', '.super-edit-element-panel > .close', function(){

            // First check for empty required fields
            var $error = false;
            $('.super-edit-element-panel .element-field[required="true"]').each(function(){
                var $this = $(this);
                if( $this.val()=='' ) {
                    var $hidden = false;
                    $this.parents('.field.filter').each(function(){
                        if($(this).css('display')=='none'){
                            $hidden = true;
                        }
                    });
                    if($hidden==false){
                        $error = true;
                        $this.addClass('super-error');
                    }
                }else{
                    $this.removeClass('super-error');
                }
            });
            if( $error==true) {
                var $first_error = $('.super-element-settings .super-error:eq(0)').parents('.field:eq(0)');
                var $parent = $first_error.parents('.tab-content:eq(0)');
                var $position = $first_error.position().top + $parent.scrollTop() - $first_error.outerHeight();
                $parent.animate({
                    scrollTop: $position
                }, 500);
                return false;
            }else{
                super_get_editing_element().removeClass('editing');
                $('.super-edit-element-panel').removeClass('super-active');
                $('.super-preview-elements').removeClass('editing-element');
            }
        });

    });

    // Get element option fied by type
    SUPER.elements_options_field = function($type, $k, $v, $data){
        if($type=='image'){
            var $html = '<div class="image-field browse-images">';
            $html += '<span class="button super-insert-image"><i class="fa fa-plus"></i>Browse images</span>';
            $html += '<ul class="image-preview">';
            var $image = '';
            if($v.default!=''){
                // Retrieve image URL from styles
                var $editing = super_get_editing_element();
                var $image = $editing.css('background-image');
                if(typeof $image !== 'undefined'){
                    $image = $image.replace('url(','').replace(')','').replace(/\"/gi, "");
                }
            }
            if($image!='' ){
                $html += '<li data-file="' + $v.default + '">';
                $html += '<div class="image"><img src="' + $image + '"></div>';
                $html += '<a href="#" class="delete">Delete</a>';
                $html += '</li>';
            }
            $html += '</ul>';

            // Background size
            var $size = $data.bg_size;
            var $options = {
                'cover':'Cover (default)', 
                'auto':'Auto', 
                'contain':'Contain', 
                'inherit':'Inherit', 
                'initial':'Initial', 
                'unset':'Unset', 
                'custom':'Custom'
            };
            $html += '<select name="bg_size" class="element-field">';
            $html += '<option value="">- background size -</option>';
            $.each($options, function(k, v){
                $html += '<option value="' + k +'"' + ($size==k ? ' selected="selected"' : '') + '>' + v + '</option>';
            });
            $html += '</select>';
            $html += '<input class="element-field" type="text" name="bg_size_custom" value="' + ($size=='custom' ? $data.bg_size_custom : '') + '" placeholder="Background size e.g 235px"' + ($size!='custom' ? ' style="display:none;"' : '') + ' />';

            // Background repeat
            var $repeat = $data.bg_repeat;
            var $options = {
                'no-repeat':'No repeat (default)', 
                'inherit':'Inherit', 
                'initial':'Initial', 
                'repeat':'Repeat', 
                'repeat-x':'Repeat X axis', 
                'repeat-y':'Repeat Y axis', 
                'round':'Round',
                'space':'Space',
                'unset':'Unset'
            };
            $html += '<select name="bg_repeat" class="element-field">';
            $html += '<option value="">- background repeat -</option>';
            $.each($options, function(k, v){
                $html += '<option value="' + k +'"' + ($repeat==k ? ' selected="selected"' : '') + '>' + v + '</option>';
            });
            $html += '</select>';

            // Background position
            var $position = $data.bg_position;
            var $options = {
                'center':'Center (default)',
                'bottom':'Bottom',
                'inherit':'Inherit',
                'initial':'Initial',
                'left':'Left',
                'right':'Right',
                'top':'Top',
                'unset':'Unset'
            };
            $html += '<select name="bg_position" class="element-field">';
            $html += '<option value="">- background position -</option>';
            $.each($options, function(k, v){
                $html += '<option value="' + k +'"' + ($position==k ? ' selected="selected"' : '') + '>' + v + '</option>';
            });
            $html += '</select>';

            $html += '<input type="hidden" name="' + $k + '" value="' + $v.default + '" id="field-' + $k + '" class="element-field" />';
            $html += '</div>';
            return $html;
        }

        if($type=='text'){
            var $html = '<div class="input">';
                $html += '<input type="text" id="field-' + $k + '"';
                if( $v.placeholder ) {
                    $html += ( $v.placeholder!='' ? 'placeholder="' + $v.placeholder + '"' : '' );
                }
                if( $v.required ) {
                    $html += ( $v.required==true ? 'required="true"' : '');
                }
                if( $v.maxlength ) {
                    $html += ( $v.maxlength > 0 ? 'maxlength="' + $v.maxlength + '"' : '' );
                }
                $html += 'name="' + $k + '" class="element-field" value="' + $v.default + '" />';
            $html += '</div>';
            return $html;

        }

        if($type=='conditions'){
            var $options = {
                'contains':'?? Contains',
                'equal':'== Equal',
                'not_equal':'!= Not equal',
                'greater_than':'> Greater than',
                'less_than':'<  Less than',
                'greater_than_or_equal':'>= Greater than or equal to',
                'less_than_or_equal':'<= Less than or equal'
            };

            var $html = '';
            if(typeof $data[$k] !== 'undefined'){
                $.each($data[$k], function($k, $v){
                    if(typeof $v.value === 'undefined') $v.value = '';
                    if(typeof $v.field === 'undefined') $v.field = '';
                    if(typeof $v.logic === 'undefined') $v.logic = '';
                    if(typeof $v.and_method === 'undefined') $v.and_method = '';
                    if(typeof $v.field_and === 'undefined') $v.field_and = '';
                    if(typeof $v.logic_and === 'undefined') $v.logic_and = '';
                    if(typeof $v.value_and === 'undefined') $v.value_and = '';
                    $html += '<div class="super-multi-items super-conditional-item">';
                        $html += '<select class="super-previously-created" name="conditional_field" data-value="' + $v.field + '"></select>';
                        $html += '<select name="conditional_logic">';
                            $html += '<option selected="selected" value="">---</option>';
                            $.each($options, function($ok, $ov){
                                $html += '<option' + ($ok==$v.logic ? ' selected="selected"' : '') + ' value="' + $ok + '">' + $ov + '</option>';
                            });
                        $html += '</select>';
                        $html += '<input type="text" placeholder="Value" value="' + $v.value + '" name="conditional_value">';
                        $html += '<select name="conditional_and_method">';
                            $html += '<option selected="selected" value="">- select -</option>';
                            $html += '<option' + ('and'==$v.and_method ? ' selected="selected"' : '') + '  value="and">AND</option>';
                            $html += '<option' + ('or'==$v.and_method ? ' selected="selected"' : '') + '  value="or">OR</option>';
                        $html += '</select>';
                        $html += '<select class="super-previously-created" name="conditional_field_and" data-value="' + $v.field_and + '"></select>';
                        $html += '<select name="conditional_logic_and">';
                            $html += '<option selected="selected" value="">---</option>';
                            $.each($options, function($ok, $ov){
                                $html += '<option' + ($ok==$v.logic_and ? ' selected="selected"' : '') + ' value="' + $ok + '">' + $ov + '</option>';
                            });
                        $html += '</select>';
                        $html += '<input type="text" placeholder="Value" value="' + $v.value_and + '" name="conditional_value_and">';
                        $html += '<i class="super-add-item fa fa-plus"></i>';
                        $html += '<i class="delete fa fa-trash-o" style="visibility: hidden;"></i>';
                        $html += '<span class="line-break"></span>';
                    $html += '</div>';
                });
            }else{
                $html += '<div class="super-multi-items super-conditional-item">';
                    $html += '<select class="super-previously-created" name="conditional_field" data-value=""></select>';
                    $html += '<select name="conditional_logic">';
                        $html += '<option selected="selected" value="">---</option>';
                        $.each($options, function($ok, $ov){
                            $html += '<option value="' + $ok + '">' + $ov + '</option>';
                        });
                    $html += '</select>';
                    $html += '<input type="text" placeholder="Value" value="" name="conditional_value">';
                    $html += '<select name="conditional_and_method">';
                        $html += '<option selected="selected" value="">- select -</option>';
                        $html += '<option value="and">AND</option>';
                        $html += '<option value="or">OR</option>';
                    $html += '</select>';
                    $html += '<select class="super-previously-created" name="conditional_field_and" data-value=""></select>';
                    $html += '<select name="conditional_logic_and">';
                        $html += '<option selected="selected" value="">---</option>';
                        $.each($options, function($ok, $ov){
                            $html += '<option value="' + $ok + '">' + $ov + '</option>';
                        });
                    $html += '</select>';
                    $html += '<input type="text" placeholder="Value" value="" name="conditional_value_and">';
                    $html += '<i class="super-add-item fa fa-plus"></i>';
                    $html += '<i class="delete fa fa-trash-o" style="visibility: hidden;"></i>';
                    $html += '<span class="line-break"></span>';
                $html += '</div>';
            }
            return $html;
        }

        if($type=='color'){
            var $html = '<div class="super-color-picker-container">';
                $html += '<div class="super-color-picker">';
                    $html += '<input type="text" id="field-' + $k + '" name="' + $k + '" class="element-field" value="' + $v.default + '" />';
                $html += '</div>';
            $html += '</div>';
            return $html;
        }



        if($type=='padding_margin_dimension'){
            if(typeof $data.radius === 'undefined') $data.radius = '';
            if(typeof $data.margin === 'undefined') $data.margin = '';
            if(typeof $data.padding === 'undefined') $data.padding = '';
            if(typeof $data.height === 'undefined') $data.height = '';
            if(typeof $data.width === 'undefined') $data.width = '';
            if(typeof $data.width_unit === 'undefined') $data.width_unit = 'px';
            if( ($data.width_unit!='px') && ($data.width_unit!='%') && ($data.width_unit!='em') && ($data.width_unit!='rem') ) {
                $data.width_unit = 'px';
            }

            var $radius = $data.radius.split(' ');
            var $margins = $data.margin.split(' ');
            var $paddings = $data.padding.split(' ');

            if( ($data.width!='') && ($data.width!=0) ) {
                $data.size = 'custom';
            }
            var $html = '<div class="super-padding-margin">';
                $html += '<div class="super-margins' + ($data.margin.length ? ' active' : '') + '">';
                    $html += '<input class="super-tooltip" title="Set a border radius (or leave blank)" type="text" name="top_left_radius" value="' + (typeof $radius[0]!=='undefined' && $radius[0]!='' ? $radius[0] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Set a border radius (or leave blank)" type="text" name="top_right_radius" value="' + (typeof $radius[1]!=='undefined' && $radius[1]!='' ? $radius[1] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Set a border radius (or leave blank)" type="text" name="bottom_right_radius" value="' + (typeof $radius[2]!=='undefined' && $radius[2]!='' ? $radius[2] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Set a border radius (or leave blank)" type="text" name="bottom_left_radius" value="' + (typeof $radius[3]!=='undefined' && $radius[3]!='' ? $radius[3] : '0') + '" />';
                    $html += '<label><span class="checkbox"></span><span>enable custom margin</span></label>';
                    $html += '<input class="super-tooltip" title="Top margin" type="text" name="top_margin" value="' + (typeof $margins[0]!=='undefined' && $margins[0]!='' ? $margins[0] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Right margin" type="text" name="right_margin" value="' + (typeof $margins[1]!=='undefined' && $margins[1]!='' ? $margins[1] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Bottom margin" type="text" name="bottom_margin" value="' + (typeof $margins[2]!=='undefined' && $margins[2]!='' ? $margins[2] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Left margin" type="text" name="left_margin" value="' + (typeof $margins[3]!=='undefined' && $margins[3]!='' ? $margins[3] : '0') + '" />';
                $html += '</div>';
                $html += '<div class="super-paddings' + ($data.padding.length ? ' active' : '') + '">';
                    $html += '<label><span class="checkbox"></span><span>enable custom padding</span></label>';
                    $html += '<input class="super-tooltip" title="Top padding" type="text" name="top_padding" value="' + (typeof $paddings[0]!=='undefined' && $paddings[0]!='' ? $paddings[0] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Right padding" type="text" name="right_padding" value="' + (typeof $paddings[1]!=='undefined' && $paddings[1]!='' ? $paddings[1] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Bottom padding" type="text" name="bottom_padding" value="' + (typeof $paddings[2]!=='undefined' && $paddings[2]!='' ? $paddings[2] : '0') + '" />';
                    $html += '<input class="super-tooltip" title="Left padding" type="text" name="left_padding" value="' + (typeof $paddings[3]!=='undefined' && $paddings[3]!='' ? $paddings[3] : '0') + '" />';
                $html += '</div>';


                $html += '<div class="super-custom-width">';
                    $html += '<input type="text" name="width" value="' + $data.width + '" class="element-field super-tooltip" title="Set a custom width (or leave blank)" />';
                    $html += '<input type="text" name="width_unit" value="' + $data.width_unit + '" class="element-field super-tooltip" title="Set the width unit e.g px or %" />';
                    $html += '<ul class="super-size">';
                        $html += '<li' + ($data.size=='1/5' ? ' class="active"' : '') + '>1/5</li>';
                        $html += '<li' + ($data.size=='1/4' ? ' class="active"' : '') + '>1/4</li>';
                        $html += '<li' + ($data.size=='1/3' ? ' class="active"' : '') + '>1/3</li>';
                        $html += '<li' + ($data.size=='2/5' ? ' class="active"' : '') + '>2/5</li>';
                        $html += '<li' + ($data.size=='1/2' ? ' class="active"' : '') + '>1/2</li>';
                        $html += '<li' + ($data.size=='3/5' ? ' class="active"' : '') + '>3/5</li>';
                        $html += '<li' + ($data.size=='2/3' ? ' class="active"' : '') + '>2/3</li>';
                        $html += '<li' + ($data.size=='3/4' ? ' class="active"' : '') + '>3/4</li>';
                        $html += '<li' + ($data.size=='4/5' ? ' class="active"' : '') + '>4/5</li>';
                        $html += '<li' + ($data.size=='1/1' ? ' class="active"' : '') + '>1/1</li>';
                    $html += '</ul>';
                $html += '</div>';

                $html += '<div class="super-custom-height">';
                    $html += '<input type="text" name="height" value="' + $data.height + '" class="element-field super-tooltip" title="Set a custom height (or leave blank)" />';
                $html += '</div>';

                $html += '<span class="super-column-content">Column contents</span>';
                $html += '<input type="hidden" name="margin" value="' + $data.margin + '" class="element-field" />';
                $html += '<input type="hidden" name="padding" value="' + $data.padding + '" class="element-field" />';
                $html += '<input type="hidden" name="radius" value="' + $data.radius + '" class="element-field" />';
                $html += '<input type="hidden" name="size" value="' + $data.size + '" class="element-field" />';
            $html += '</div>';
            return $html;
        }
        if($type=='slider'){
            var $html = '<div class="slider-field">';
            $html += '<input type="text" name="' + $k + '" value="' + $v.default + '" id="field-' + $k + '" data-steps="' + $v.steps + '" data-min="' + $v.min + '" data-max="' + $v.max + '" class="element-field" />';
            $html += '</div>';
            return $html;
        }
        if($type=='checkbox'){
            var $html = '<div class="super-checkbox">';
            $.each($v.values, function($kk, $vv){
                $checked = '';
                if( ($v.multiple) && ($v.default!='') ) {
                    if($kk.indexOf($v.default) == -1){
                        $checked = ' checked="checked"';
                    }
                }else{
                    if( $v.default==$kk ) {
                        $checked = ' checked="checked"';
                    }
                }
                $html += '<label><input type="checkbox" value="' + $kk + '"' + $checked + '>' + $vv +'</label>';

            });
            $html += '<input type="hidden" name="' + $k + '" value="' + $v.default + '" id="field-' + $k + '"  class="element-field" />';
            $html += '</div>';
            return $html;
        }
    
        if( ($type=='select') || ($type=='dropdown') ) {
            if( $v.multiple ) {
                $v.multiple = ' multiple';
            }else{
                $v.multiple = '';
            }
            if( $v.filter ) $v.filter = ' filter';
            var $html = '<div class="input">';
                $html += '<select id="field-' + $k + '" name="' + $k + '" class="element-field' + $v.multiple + '"' + $v.multiple + $v.filter + '>';
                $.each($v.values, function($kk, $vv){
                    $selected = '';
                    if( ($v.multiple) && ($v.default!='') ) {
                        if($kk.indexOf($v.default) == -1){
                            $selected = ' selected="selected"';
                        }
                    }else{
                        if( $v.default==$kk ) {
                            $selected = ' selected="selected"';
                        }
                    }
                    $html += '<option value="' + $kk + '"' + $selected + '>' + $vv +'</option>';
                });
                $html += '</select>';
                if($v.info) $html += '<p>' + $v.info + '</p>';
            $html += '</div>';
            return $html;
        }
        if( $type=='positioning' ){
            if($v.default==''){
                $v.default = 'top:left:fixed:33:%:1/2'; // top = positioning, left = alignment, fixed = width method, 33 = width size, % = width unit, 1/2 = flex width
            }

            var $values = $v.default.split(':');
            $values = super_get_label_positioning_values(undefined, $values);

            // Label Positioning
            $html = '<div class="super-positioning">';
                // Top
                $html += ($values[0]=='top') ? '<label class="active ' : '<label class="';
                $html += 'top super-tooltip" title="Label above field"></label>';
                // Left
                $html += ($values[0]=='left') ? '<label class="active ' : '<label class="';
                $html += 'left super-tooltip" title="Label left from field"></label>';
                // Bottom
                $html += ($values[0]=='bottom') ? '<label class="active ' : '<label class="';
                $html += 'bottom super-tooltip" title="Label below field"></label>';
                // Right
                $html += ($values[0]=='right') ? '<label class="active ' : '<label class="';
                $html += 'right super-tooltip" title="Label right from field"></label>';
            $html += '</div>';

            // Label Alignment
            $html += '<div class="super-alignment">';
                // Left
                $html += ($values[1]=='left') ? '<label class="active ' : '<label class="';
                $html += 'left super-tooltip" title="Align left"></label>';
                // Center
                $html += ($values[1]=='center') ? '<label class="active ' : '<label class="';
                $html += 'center super-tooltip" title="Align center"></label>';
                // Right
                $html += ($values[1]=='right') ? '<label class="active ' : '<label class="';
                $html += 'right super-tooltip" title="Align right"></label>';

            $html += '</div>';

            // Label Width
            $html += '<div class="super-width">';
                // Auto
                $html += ($values[2]=='auto') ? '<label class="active ' : '<label class="';
                $html += 'auto super-tooltip" title="Automatic width">Auto</label>';
                // Flex
                $html += ($values[2]=='flex') ? '<label class="active ' : '<label class="';
                $html += 'flex super-tooltip" title="Flex width">Flex</label>';
                // Fixed
                $html += ($values[2]=='fixed') ? '<label class="active ' : '<label class="';
                $html += 'fixed super-tooltip" title="Fixed width">Fixed</label>';

                // Label custom width inputs
                var $style = 'none;';
                if( $values[2]=='fixed') {
                    $style = 'block;';
                }
                $html += '<div class="super-width-custom" style="display:'+$style+';">';
                    $html += '<input type="text" name="width" value="' + $values[3] + '" class="element-field super-tooltip" title="Set a custom width (or leave blank)" />';
                    $html += '<input type="text" name="width_unit" value="' + $values[4] + '" class="element-field super-tooltip" title="Set the width unit e.g px or %" />';
                $html += '</div>';
                var $style = 'none;';
                if( $values[2]=='flex') {
                    $style = 'block;';
                }
            $html += '</div>';

            $html += '<ul class="super-flex-size super-tooltip" title="Choose a size for your Flex width" style="display:'+$style+';">';
                $html += '<li' + ($values[5]=='1/5' ? ' class="active"' : '') + '>1/5</li>';
                $html += '<li' + ($values[5]=='1/4' ? ' class="active"' : '') + '>1/4</li>';
                $html += '<li' + ($values[5]=='1/3' ? ' class="active"' : '') + '>1/3</li>';
                $html += '<li' + ($values[5]=='2/5' ? ' class="active"' : '') + '>2/5</li>';
                $html += '<li' + ($values[5]=='1/2' ? ' class="active"' : '') + '>1/2</li>';
                $html += '<li' + ($values[5]=='3/5' ? ' class="active"' : '') + '>3/5</li>';
                $html += '<li' + ($values[5]=='2/3' ? ' class="active"' : '') + '>2/3</li>';
                $html += '<li' + ($values[5]=='3/4' ? ' class="active"' : '') + '>3/4</li>';
                $html += '<li' + ($values[5]=='4/5' ? ' class="active"' : '') + '>4/5</li>';
            $html += '</ul>';

            $html += '<div class="super-font-styles">';
                $html += '<div class="super-font-color"><span>Color:</span><input type="text" name="color" /></div>';
                $html += '<div class="super-font-size"><span>Size:</span><input type="text" name="size" /></div>';
                $html += '<div class="super-font-weight"><span>Weight:</span><input type="text" name="weight" /></div>';
                $html += '<div class="super-font-transform"><span>Transform:</span><input type="text" name="transform" /></div>';
                $html += '<div class="super-font-style"><span>Style:</span><input type="text" name="style" /></div>';
                $html += '<div class="super-font-decoration"><span>Decoration:</span><input type="text" name="decoration" /></div>';
                $html += '<div class="super-font-family"><span>Family:</span><input type="text" name="family" /></div>';
                $html += '<div class="super-font-line-height"><span>Line-height:</span><input type="text" name="line_height" /></div>';
                $html += '<div class="super-font-letter-spacing"><span>Letter spacing:</span><input type="text" name="letter_spacing" /></div>';
            $html += '</div>';

            $html += '<input type="hidden" name="' + $k + '" value="' + $v.default + '" id="field-' + $k + '"  class="element-field" />';
            return $html;
        }
        if( ($type=='radio_items') || ($type=='autosuggest_items') || ($type=='checkbox_items') )  {
            $html = '<div class="field-info-message"></div>';
            $($v.default).each(function($kk, $vv){
                $html += '<div class="super-multi-items super-dropdown-item">';
                    if( typeof $vv.checked === 'undefined' ) $vv.checked = 'false';
                    $html += '<input data-prev="' + $vv.checked + '" ' + ($type=='radio_items' || $type=='autosuggest_items' ? 'type="radio"' : 'type="checkbox"') + ( $vv.checked==true ? ' checked="checked"' : '' ) + '>';
                    $html += '<div class="sorting">';
                        $html += '<span class="up"><i class="fa fa-arrow-up"></i></span>';
                        $html += '<span class="down"><i class="fa fa-arrow-down"></i></span>';
                    $html += '</div>';
                    $html += '<input type="text" placeholder="' + 'Label' + '" value="' + $vv.label + '" name="label">';
                    $html += '<input type="text" placeholder="' + 'Value' + '" value="' + $vv.value + '" name="value">';

                    // @since v1.2.3
                    if( ($type=='checkbox_items') || ($type=='radio_items') ) {
                        if(!$vv.image)  $vv.image = '';
                        $html += '<div class="image-field browse-images">';
                        $html += '<span class="button super-insert-image"><i class="fa fa-picture-o"></i></span>';
                        $html += '<ul class="image-preview">';
                        var $image = '';
                        if($vv.image!=''){
                            // Retrieve image URL from styles
                            var $editing = super_get_editing_element();
                            var $item = $editing.find('.super-field-wrapper > label:eq('+$kk+')')
                            var $image = $item.children('.image')[0].style.backgroundImage
                            if(typeof $image !== 'undefined'){
                                $image = $image.replace('url(','').replace(')','').replace(/\"/gi, "");
                            }
                        }
                        if($image!='' ){
                            $html += '<li data-file="' + $vv.image + '">';
                                $html += '<div class="image"><img src="' + $image + '"></div>';
                                $html += '<input type="number" placeholder="' + 'width' + '" value="' + $vv.width + '" name="width">';
                                $html += '<span>px</span>';
                                $html += '<input type="number" placeholder="' + 'height' + '" value="' + $vv.height + '" name="height">';
                                $html += '<span>px</span>';
                                $html += '<a href="#" class="delete">Delete</a>';

                                // Background size
                                var $size = $vv.bg_size;
                                var $options = {
                                    'cover':'Cover (default)', 
                                    'auto':'Auto', 
                                    'contain':'Contain', 
                                    'inherit':'Inherit', 
                                    'initial':'Initial', 
                                    'unset':'Unset', 
                                    'custom':'Custom'
                                };
                                $html += '<select name="bg_size">';
                                $html += '<option value="">- background size -</option>';
                                $.each($options, function(k, v){
                                    $html += '<option value="' + k +'"' + ($size==k ? ' selected="selected"' : '') + '>' + v + '</option>';
                                });
                                $html += '</select>';
                                $html += '<input type="text" name="bg_size_custom" value="' + ($size=='custom' ? $vv.bg_size_custom : '') + '" placeholder="Background size e.g 235px"' + ($size!='custom' ? ' style="display:none;"' : '') + ' />';

                                // Background repeat
                                var $repeat = $vv.bg_repeat;
                                var $options = {
                                    'no-repeat':'No repeat (default)', 
                                    'inherit':'Inherit', 
                                    'initial':'Initial', 
                                    'repeat':'Repeat', 
                                    'repeat-x':'Repeat X axis', 
                                    'repeat-y':'Repeat Y axis', 
                                    'round':'Round',
                                    'space':'Space',
                                    'unset':'Unset'
                                };
                                $html += '<select name="bg_repeat">';
                                $html += '<option value="">- background repeat -</option>';
                                $.each($options, function(k, v){
                                    $html += '<option value="' + k +'"' + ($repeat==k ? ' selected="selected"' : '') + '>' + v + '</option>';
                                });
                                $html += '</select>';

                                // Background position
                                var $position = $vv.bg_position;
                                var $options = {
                                    'center':'Center (default)',
                                    'bottom':'Bottom',
                                    'inherit':'Inherit',
                                    'initial':'Initial',
                                    'left':'Left',
                                    'right':'Right',
                                    'top':'Top',
                                    'unset':'Unset'
                                };
                                $html += '<select name="bg_position">';
                                $html += '<option value="">- background position -</option>';
                                $.each($options, function(k, v){
                                    $html += '<option value="' + k +'"' + ($position==k ? ' selected="selected"' : '') + '>' + v + '</option>';
                                });
                                $html += '</select>';


                            $html += '</li>';
                        }
                        $html += '</ul>';
                        $html += '<input type="hidden" name="image" value="' + $vv.image + '" />';
                        $html += '</div>';
                    }

                    $html += '<i class="super-add-item fa fa-plus"></i>';
                    $html += '<i class="delete fa fa-trash-o"></i>';
                $html += '</div>';
            });

            $html += '<textarea name="' + $type + '" class="element-field multi-items-json">' + JSON.stringify($v.default) + '</textarea>';

            return $html;
        }
    }

    // Reposition Edit Element Panel
    SUPER.reposition_edit_element_panel = function($edit_panel, $editing){
        setTimeout(function(){
            if(typeof $editing === 'undefined'){
                var $editing = super_get_editing_element();
            }
            if(typeof $edit_panel === 'undefined'){
                var $edit_panel = $('.super-preview-elements .super-edit-element-panel');
            }
            var $canvas = $('.super-preview-elements');
            var $width = $canvas.outerWidth(true);
            var $left = $editing.offset().left-$canvas.offset().left;
            var $editing_width = $editing.width();
            var $right = $width-($left+$editing_width);
            $edit_panel.css('left', '').css('right', $right+'px');
            var $top = $editing.offset().top-$canvas.offset().top+10;
            var $height = $editing.outerHeight();
            $top = $top + $height;
            $edit_panel.css('top', $top+'px');
        },10);
    }

    // Generate element settings
    SUPER.generate_element_settings = function($options, $data){
        var $options = JSON.parse($options);
        var $data = JSON.parse($data);
        var $html = '';

        // Tabs
        $html += '<div class="super-element-settings-tabs">';
            $html += '<select>';
                var $i = 0;
                $.each($options, function($k, $v){
                    $html += '<option';
                    if($i==0){
                        $html += ' selected="selected"';
                    }
                    $html += ' value="' + $i + '">' + $v.name + '</option>';
                    $i++;
                });
            $html += '</select>';
        $html += '</div>';

        // Close button
        $html += '<div class="close">Close</div>';

        var $i = 0;
        $.each($options, function($k, $v){
            $html += '<div class="tab-content';
            if($i==0) $html += ' active';
            $html += '">';
                if(typeof $v.fields !== 'undefined'){
                    $.each($v.fields, function($fk, $fv){
                        var $filter = '';
                        var $parent = '';
                        var $filtervalue = '';
                        if( $fv.filter==true ) {
                            $filter = ' filter';
                            if( $fv.parent ) $parent = ' data-parent="' + $fv.parent + '"';
                            if( $fv.filter_value ) $filtervalue = ' data-filtervalue="' + $fv.filter_value + '"';
                        }
                        var $hidden = '';
                        if( $fv.hidden==true ) {
                            $hidden = ' hidden';
                        }
                        var $class = '';
                        if(typeof $fv.type !== 'undefined'){
                            $class += ' field-type-'+$fv.type;
                        }
                        if( ($fv.type=='radio_items') || ($fv.type=='autosuggest_items') || ($fv.type=='checkbox_items') || ($fv.type=='conditions') )  {
                            $class += ' multi-items';
                        }
                        if( $fv.type=='padding_margin_dimension' ) {
                            $class += ' padding-margin';
                        }

                        $html += '<div class="field' + $filter + $hidden + $class + '"' + $parent + '' + $filtervalue + '>';
                            if( $fv.name ) $html += '<div class="field-name">' + $fv.name + '</div>';
                            if( $fv.desc ) $html += '<i class="info super-tooltip" title="' + $fv.desc + '"></i>';
                            if( $fv.label ) $html += '<div class="field-label">' + $fv.label + '</div>';
                            $html += '<div class="field-input"';
                            if( $fv.allow_empty!='' ) {
                                $html += ' data-allow-empty="true"';
                            }
                            if($fv.default!==''){
                                $html += ' data-default="' + $fv.default + '"';
                            }
                            $html += '>';
                                if( !$fv.type ) $fv.type = 'text';
                                if( $data[$fk] ) {
                                    $fv.default = $data[$fk];
                                }
                                $html += SUPER.elements_options_field($fv.type, $fk, $fv, $data);
                            $html += '</div>';

                            if($fk=='label'){
                                $fv.default = '';
                                if(typeof $data['label_position'] !== 'undefined'){
                                    $fv.default = $data['label_position'];
                                }
                                $html += SUPER.elements_options_field('positioning', 'label_position', $fv, $data);
                            }

                        $html += '</div>';
                    });
                }
            $html += '</div>';
            $i = 1;
        
        });
        return $html;

    }

    // Convert HEX color code to RGB
    SUPER.hex2rgb = function($hex, $opacity){
        if(typeof $opacity === 'undefined') var $opacity = 1;
        var $c;
        if(/^#([A-Fa-f0-9]{3}){1,2}$/.test($hex)){
            $c= $hex.substring(1).split('');
            if($c.length== 3){
                $c = [$c[0], $c[0], $c[1], $c[1], $c[2], $c[2]];
            }
            $c = '0x'+$c.join('');
            return 'rgba('+[($c>>16)&255, ($c>>8)&255, $c&255].join(',')+','+$opacity+')';
        }
        return '';
    }

    // Loading States
    SUPER.loading_states = function(button, status){
        status = status || 'loading';
        if(status=='loading'){
            var old_html = button.html();
            button.data('old-html',old_html);
            button.parents('.super-form-button:eq(0)').addClass('super-loading');
            button.html('<i class="fa fa-refresh fa-spin"></i>');
        }else{
            button.parents('.super-form-button:eq(0)').removeClass('super-loading')
            button.html(button.data('old-html'));
        }
    }

    // Check if the added field has an unique field name
    SUPER.check_for_unique_field_name = function($element){
        var $field = $element.find('.super-shortcode-field');
        // @since v1.2.3 check if we are not importing predefined element
        if($field.length==1){
            if( typeof $field !== 'undefined' ) {
                if( typeof $field.attr('name') !== 'undefined' ) {
                    var $name = $field.attr('name').replace('[','').replace(']','');
                    var $exists = $('.super-preview-elements .super-shortcode-field[name="'+$name+'"]');
                    if($exists.length==0){
                        var $field = $element.find('.super-selected-files');
                        var $name = $field.attr('name').replace('[','').replace(']','');
                        var $exists = $('.super-preview-elements .super-selected-files[name="'+$name+'"]');
                    }
                    if($exists.length>0){
                        var $unique_name = SUPER.generate_unique_field_name($field, $name, $name, 0);
                        $field.attr('name',$unique_name);
                        var $data = $.parseJSON($element.children('textarea[name="element-data"]').val());
                        $data.name = $unique_name;

                        // @since 3.7.0 - change unique field name on the fly
                        $element.find('.super-title > input').val($unique_name);
                        
                        var $data = JSON.stringify($data);
                        $element.children('textarea[name="element-data"]').val($data);
                    }
                }
            }
        }
    }

    // Generate unique field name for a given element
    SUPER.generate_unique_field_name = function($field, $name, $new_name, $counter){
        var $exists = $('.super-preview-elements .super-shortcode-field[name="'+$new_name+'"]');
        if( $exists.length==0 ) {
            var $exists = $('.super-preview-elements .super-selected-files[name="'+$new_name+'"]');
        }
        if( $exists.length>1 ) {
            $counter++;
            $new_name = $name+'_'+$counter;
            $field.attr('name',$new_name);
            return SUPER.generate_unique_field_name($field, $name, $new_name, $counter);
        }else{
            return $new_name;
        }
    }

    // Regenerate Element Final Output (inner)
    SUPER.regenerate_element_inner = function($target){
        if($target==2){
            var $elements = $('textarea[name="_super_elements"].active').val();
        }else{
            var $elements = SUPER.regenerate_element_inner.get_elements($target);
            var $elements = JSON.stringify($elements);
        }
        $('textarea[name="_super_elements"].active').val($elements);
        if($target==2){
            SUPER.save_form($('.super-actions .save'), 2);
        }else{
            SUPER.trigger_redo_undo();
        }
    }
    SUPER.regenerate_element_inner.get_elements = function($target){
        var $elements = [];
        $target.children('.super-element').each(function(){
            var $this = $(this);
            var $tag = $this.data('shortcode-tag');
            var $group = $this.data('group');
            var $data = $.parseJSON($this.children('textarea[name="element-data"]').val());
            if($data==null) $data = {};
            if( typeof $this.attr('data-minimized') !== 'undefined' ) {
                if($this.attr('data-minimized')=='no'){
                    if( typeof $data.minimized !== 'undefined' ) {
                        delete $data.minimized;
                    }
                }else{
                    $data.minimized = $this.attr('data-minimized');
                }
            }
            if($tag=='column'){
                var $size = $this.attr('data-size');
                if( $size!='1/1' ) {
                    $data.size = $size;
                }else{
                    if( typeof $data.size !== 'undefined' ) {
                        delete $data.size;
                    }
                }
            }
            var $push = {};
            $push['tag'] = $tag;
            $push['group'] = $group;

            if( ($tag=='column') || ($tag=='multipart') ) {
                var $inner = SUPER.regenerate_element_inner_children($this);
                $push['inner'] = $inner;
            }

            // Delete empty values
            Object.keys($data).forEach((key) => ($data[key] == null) && delete $data[key]);
            if(Object.keys($data).length !== 0 && $data.constructor === Object){
                $push['data'] = $data;
            }

            $elements.push($push);

        });
        return $elements;
    }

    // Also collect all inner items
    SUPER.regenerate_element_inner_children = function($target){
        var $target = $target.children('.super-element-inner');
        if($target.children('.super-element').length){
            return SUPER.regenerate_element_inner.get_elements($target);
        }else{
            return '';
        }
    }

    // Re initialize drop here placeholder (image)
    SUPER.init_drop_here_placeholder = function(){
        $('.super-preview-elements').addClass('drop-here-placeholder');
        SUPER.init_drag_and_drop();
    }

    // Initialize elements so they can be sortable
    SUPER.init_drag_and_drop = function(){
        var $container = $('.super-preview-elements');
        /*
        // For now disabled, maybe we will use it in the future?
        $('.super-preview-elements').find('.super-column').resizable({
            resize: function(event, ui) {
                if(ui.originalElement.parent().hasClass('super-preview-elements')){
                    var $width = $(this).parents('.super-preview-elements').width();
                    if( ui.size.width>$width ) {
                        ui.size.width = $width;
                    }
                }else{
                    var $width = $(this).parents('.super-element-inner').width();
                    var $margin = 25; 
                    if( (ui.size.width+$margin)>$width ) {
                        ui.size.width = $width;
                    }else{
                        ui.size.width = ui.size.width+$margin;
                    }
                }
            },
            stop: function (event, ui) {
                SUPER.init_drag_and_drop();
            }
        });
        */


        // @since 4.2.0 - new drag and drop method
        /*
        Sortable.create(document.querySelector('.super-preview-elements'), {
            draggable: '.super-element, .super-column',
            group: {
                name: 'elements'
            },
            animation: 0,
            chosenClass: "super-chosen",
            forceFallback: true,
            onStart: function () {
                $('.super-preview-elements').addClass('dragging');
            },
            onEnd: function () {
                $('.super-preview-elements').removeClass('dragging');
            }
        });
        [].forEach.call(document.querySelector('.super-preview-elements').getElementsByClassName('super-element-inner'), function (el){
            Sortable.create(el, {
                draggable: '.super-element, .super-column',
                group: {
                    name: 'elements',
                },
                animation: 0,
                chosenClass: "super-chosen",
                forceFallback: true,
                onStart: function () {
                    $('.super-preview-elements').addClass('dragging');
                },
                onEnd: function () {
                    $('.super-preview-elements').removeClass('dragging');
                }
            });
        });
        */

    }

    // Scroll function when dropable or sortable element is activated
    SUPER.handleNear = function(){
        var $scrolled = $(window).scrollTop();
        var $buffer = 20;
        var $docHeight = $(document).outerHeight(true);
        var $windowHeight = $(window).outerHeight(true);
        var $near_top = $scrolled - this.ev.y >= $buffer;  
        var $near_bottom = $scrolled + $windowHeight - this.ev.y <= $buffer;  
        if($near_top){
            window.scrollTo(0, $scrolled - $buffer);
        }
        if(($near_bottom) && ((this.ev.y+$buffer) < $docHeight)){
            window.scrollTo(0, this.ev.y + $buffer - $windowHeight);
        }        
    }

    SUPER.init_previously_created_fields = function(){
        
        var $options = {};
        $('.super-preview-elements .super-element').each(function(){
            var $data = $(this).children('textarea[name="element-data"]').val();
            var $data = JSON.parse($data);
            // Skip element if data is null
            if( $data!=null ) {
                var $name = $data.name;
                var $email = $data.email;
                if( typeof $name !== 'undefined' ) {
                    if( typeof $email === 'undefined' ) {
                        $email = $name;
                    }
                    $options[$name] = {
                        selected: '<option selected="selected" value="'+$name+'">'+$name+': '+$email+'</option>',
                        default: '<option value="'+$name+'">'+$name+': '+$email+'</option>'
                    };
                }
            }
        });

        $('.super-multi-items .super-previously-created, .previously-created-fields').each(function(){
            var $this = $(this);
            var $value = $this.data('value');
            if( $this.parent().hasClass('address-auto-popuplate-item') ) {
                var $options_html = '<option value="">- select a field -</option>';  
            }else{
                var $options_html = '';
            }
            $.each($options, function(key, value){
                if( $value==key ) {
                    $options_html += value.selected;
                }else{
                    $options_html += value.default;
                }
            });
            $this.html($options_html);
        });
        $('.super-element-settings .super-elements-container select[name="connected_min"]').each(function(){
            var $this = $(this);
            var $current = super_get_editing_element().find('.super-shortcode-field');
            var $value = $current.attr('data-connected_min');
            var $options_html = '';
            $.each($options, function(key, value){
                var $found = $this.find('option[value="'+key+'"]').length;
                if( $found==0 ) {
                    if( $value==key ) {
                        $options_html += value.selected;
                    }else{
                        $options_html += value.default;
                    }
                }
            });
            $options_html = '<option value="">- Not connected -</option>'+$options_html;
            $this.html($options_html);
        });
        $('.super-element-settings .super-elements-container select[name="connected_max"]').each(function(){
            var $this = $(this);
            var $current = super_get_editing_element().find('.super-shortcode-field');
            var $value = $current.attr('data-connected_max');
            var $options_html = '';
            $.each($options, function(key, value){
                var $found = $this.find('option[value="'+key+'"]').length;
                if( $found==0 ) {
                    if( $value==key ) {
                        $options_html += value.selected;
                    }else{
                        $options_html += value.default;
                    }
                }
            });
            $options_html = '<option value="">- Not connected -</option>'+$options_html;
            $this.html($options_html);
        });
    }

    SUPER.update_multi_items = function($this){
        var $parent = $this.children('.field-input');
        var $items = [];
        $parent.find('.super-multi-items').each(function(){
            var $this = $(this);
            if($this.hasClass('super-conditional-item')){
                $items.push({ 
                    field: $this.children('select[name="conditional_field"]').val(),
                    logic: $this.children('select[name="conditional_logic"]').val(),
                    value: $this.children('input[name="conditional_value"]').val(),
                    and_method: $this.children('select[name="conditional_and_method"]').val(),
                    field_and: $this.children('select[name="conditional_field_and"]').val(),
                    logic_and: $this.children('select[name="conditional_logic_and"]').val(),
                    value_and: $this.children('input[name="conditional_value_and"]').val(),
                    new_value: $this.children('textarea[name="conditional_new_value"]').val()
                });
            }else if($this.hasClass('address-auto-popuplate-item')){
                $items.push({ 
                    key: $this.children('input[name="key"]').val(),
                    field: $this.children('select[name="field"]').val(),
                    type: $this.children('select[name="type"]').val()
                });
            }else{
                if($this.children('input[type="checkbox"]').length){
                    var $checked = $this.children('input[type="checkbox"]').is(':checked');
                }
                if($this.children('input[type="radio"]').length){
                    var $checked = $this.children('input[type="radio"]').is(':checked');
                }
                $items.push({ 
                    checked: $checked,
                    image: $this.find('input[name="image"]').val(),
                    width: $this.find('input[name="width"]').val(),
                    height: $this.find('input[name="height"]').val(),
                    bg_size: $this.find('select[name="bg_size"]').val(),
                    bg_size_custom: $this.find('input[name="bg_size_custom"]').val(),
                    bg_repeat: $this.find('select[name="bg_repeat"]').val(),
                    bg_position: $this.find('select[name="bg_position"]').val(),
                    label: $this.children('input[name="label"]').val(),
                    value: $this.children('input[name="value"]').val()
                });
            }
        });
        var $items = JSON.stringify($items);
        $parent.children('textarea').val($items);
    }

    SUPER.init_dragable_elements = function() {
        $('.draggable-element').pep({
            activeClass: 'active',
            droppableActiveClass: 'dropping-allowed',
            droppableParentActiveClass: 'dropping-allowed-active',
            droppable: '.super-dropable',
            start: function(ev, obj){
                SUPER.init_drop_here_placeholder();
                obj.noCenter = true;
                var top = obj.$el.css('top').replace('px','');
                var left = obj.$el.css('left').replace('px','');
                if(typeof obj.$el.attr('data-start-position-top') === 'undefined'){
                    obj.$el.attr('data-start-position-top', top)
                    obj.$el.attr('data-start-position-left', left)
                }            
            },
            drag:function(e) {
                SUPER.handleNear.apply(this);
            },
            stop: function(ev, obj){
                if(this.activeDropRegions.length>0){
                    var $tag = obj.$el.data('shortcode');
                    var $target = $('.dropping-allowed:not(:has(.dropping-allowed))');
                    var $multipart_found = $target.closest('[data-shortcode-tag="multipart"]').length;
                    if( ( ($multipart_found>0) && ($tag==='multipart_pre') ) ) {
                        alert(super_create_form_i18n.alert_multipart_error);
                        return false;
                    }

                    var $column_found = $target.closest('[data-shortcode-tag="column"]').length;
                    if( ( ($column_found>0) && ($tag==='multipart_pre') ) ) {
                        alert(super_create_form_i18n.alert_column_error);
                        return false;
                    }

                    var $predefined = '';
                    if( typeof obj.$el.find('.predefined').val() !== 'undefined' ) {
                        $predefined = JSON.parse(obj.$el.find('.predefined').val());
                    }
                    $.ajax({
                        type: 'post',
                        url: ajaxurl,
                        data: {
                            action: 'super_get_element_builder_html',
                            tag: obj.$el.data('shortcode'),
                            group: obj.$el.data('group'),
                            predefined: $predefined,
                            form_id: $('input[name="form_id"]').val()
                        },
                        success: function (data) {
                            var $element = $(data).appendTo($target);
                            SUPER.init_resize_element_labels();
                            SUPER.check_for_unique_field_name($element);
                            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
                            super_generate_first_column_classes(0, 0);
                            SUPER.init_skype();
                            SUPER.init_tooltips();
                            SUPER.init_datepicker();
                            SUPER.init_masked_input();
                            SUPER.init_currency_input();
                            SUPER.init_colorpicker();
                            SUPER.init_slider_field();
                            SUPER.init_button_colors();
                            SUPER.init_drop_here_placeholder();
                        }
                    });
                }else{
                    obj.cssX = 0
                    obj.cssY = 0
                    obj.translation = "matrix(1, 0, 0, 1, 0, 0)"
                    obj.transform(obj.translation)
                    obj.$el.css('top', '0').css('left', '0');
                }
            },
            revert: true,
            cssEaseDuration: 0,
        });
    }

    // $preview - if set to "1" show preview, if set to "2" also do a page reload (required for loading example forms)
    // $change_builder_mode - only set when button was clicked to change the builder mode
    SUPER.save_form = function( $this, $preview, $change_builder_mode ) {
        if(typeof $change_builder_mode === 'undefined') var $change_builder_mode = '';

        var $fields = $('.super-preview-elements .super-shortcode-field, .super-preview-elements .super-selected-files');
        var $error = false;
        
        // First reste all classes
        $('.super-preview-elements .super-element.error').removeClass('error');

        // @since 4.0.0 - see if we need to skip this validation when user choose to disable validation check on unique field names
        var $allow = $('input[name="allow_duplicate_names"]').is(':checked');
        if( !$allow ) {
            $fields.each(function(){
                var $origin_field = $(this);
                if($origin_field.parents('.super-file:eq(0)').length) {
                    var $duplicate_fields = $('.super-preview-elements .super-selected-files[name="'+$(this).attr('name')+'"]');
                }else{
                    var $duplicate_fields = $('.super-preview-elements .super-shortcode-field[name="'+$(this).attr('name')+'"]');
                }
                if($duplicate_fields.length > 1){
                    $duplicate_fields.parents('.super-element').addClass('error');
                    $error = true;
                }
            });
            if($error == true) {
                alert(super_create_form_i18n.alert_duplicate_field_names);
                return false;
            } 
        }
        
        $this.html('<i class="fa fa-save"></i>Saving...');

        var $settings = {};
        $('.super-create-form .super-form-settings .element-field').each(function(){
            var $this = $(this);
            var $name = $this.attr('name');
            var $value = $this.val();
            $settings[$name] = $value;
        });

        $.ajax({
            type: 'post',
            url: ajaxurl,
            data: {
                action: 'super_save_form',
                id: $('.super-create-form input[name="form_id"]').val(),
                title: $('.super-create-form input[name="title"]').val(),
                shortcode: $('textarea[name="_super_elements"].active').val(),
                settings: $settings,
                change_builder_mode: $change_builder_mode // empty by default, only set when changing builder type via button
            },
            success: function (data) {
                $('.super-create-form .super-get-form-shortcodes').val('[super_form id="'+data+'"]');
                $('.super-create-form input[name="form_id"]').val(data);
                $('.super-create-form .super-actions .save').html('<i class="fa fa-save"></i>Save');
                if($preview==1){
                    var $this = $('.super-create-form .super-actions .preview:eq(3)');
                    SUPER.preview_form($this);
                }else{
                    var href = window.location.href;
                    var page = href.substr(href.lastIndexOf('/') + 1);
                    var str2 = "admin.php?page=super_create_form&id";
                    if(page.indexOf(str2) == -1){
                        window.location.href = "admin.php?page=super_create_form&id="+data;
                    }else{
                        if($preview==2){
                            location.reload();
                        }                    
                    }
                }
            }
        });
    }
    SUPER.preview_form = function( $this ) {  
        if($('input[name="form_id"]').val()==''){
            alert(super_create_form_i18n.alert_save);
            return false;
        }
        if(!$this.hasClass('active')){
            $this.html('Loading...');
            $('.super-live-preview').html('');
            $('.super-preview-elements').css('display','none');
            $('.super-live-preview').addClass('loading').css('display','block');
            var $form_id = $('.super-create-form input[name="form_id"]').val();
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_load_preview',
                    id: $form_id,
                },
                success: function (data) {
                    $('.super-live-preview').removeClass('loading');
                    $('.super-live-preview').html(data);
                    $this.html('Builder');
                },
                complete: function () {
                    SUPER.handle_columns();
                    SUPER.init_button_colors();
                    SUPER.init_super_responsive_form_fields();
                    SUPER.init_super_form_frontend();
                    SUPER.after_preview_loaded_hook($form_id);
                }
            });
        }else{
            $('.super-live-preview').css('display','none');
            $('.super-preview-elements').css('display','block');
            $this.html('Preview');
        }
        $this.toggleClass('active');
    }

    // Update export json
    SUPER.init_resize_element_labels = function() {
        $('.super-create-form .super-element-header .super-element-label > input').each(function(){
            var $span = $(this).parent().children('span');
            var $width = $span.outerWidth(true);
            $(this).parent().css('width', $width+'px').css('margin-left', '-'+($width/2)+'px');
        });   
    }

    // @since 2.9.0 - form setup wizard
    SUPER.update_wizard_preview = function($theme, $size, $icon, $save) {
        if($theme==null) $theme = $('.super-theme-style-wizard li.super-active').attr('data-value');
        if($size==null) $size = $('.super-field-size-wizard li.super-active').attr('data-value');
        if($icon==null) $icon = $('.super-theme-hide-icons-wizard li.super-active').attr('data-value');
        if($theme=='squared') $theme_setting = '';
        if($theme=='rounded') $theme_setting = 'super-default-rounded';
        if($theme=='full-rounded') $theme_setting = 'super-full-rounded';
        if($theme=='minimal') $theme_setting = 'super-style-one';
        if($icon=='no') $icon_setting = 'yes';
        if($icon=='yes') $icon_setting = 'no';
        if($save==true){
            $('.super-create-form select[name="theme_style"]').val($theme_setting);
            $('.super-create-form select[name="theme_field_size"]').val($size);
            $('.super-create-form select[name="theme_hide_icons"]').val($icon_setting);
            $('.super-create-form input[name="title"]').val($('.super-create-form input[name="wizard_title"]').val());
            
            $('.super-create-form input[name="header_to"]').val($('.super-create-form input[name="wizard_header_to"]').val());
            $('.super-create-form select[name="header_from_type"]').val('custom');
            $('.super-create-form input[name="header_from"]').val($('.super-create-form input[name="wizard_header_from"]').val());
            $('.super-create-form input[name="header_from_name"]').val($('.super-create-form input[name="wizard_header_from_name"]').val());
            $('.super-create-form input[name="header_subject"]').val($('.super-create-form input[name="wizard_header_subject"]').val());
            $('.super-create-form textarea[name="email_body_open"]').val($('.super-create-form textarea[name="wizard_email_body_open"]').val());

            $('.super-create-form input[name="confirm_to"]').val($('.super-create-form input[name="wizard_confirm_to"]').val());
            $('.super-create-form select[name="confirm_from_type"]').val('custom');
            $('.super-create-form input[name="confirm_from"]').val($('.super-create-form input[name="wizard_confirm_from"]').val());
            $('.super-create-form input[name="confirm_from_name"]').val($('.super-create-form input[name="wizard_confirm_from_name"]').val());
            $('.super-create-form input[name="confirm_subject"]').val($('.super-create-form input[name="wizard_confirm_subject"]').val());
            $('.super-create-form textarea[name="confirm_body_open"]').val($('.super-create-form textarea[name="wizard_confirm_body_open"]').val());

            $('.super-create-form input[name="form_thanks_title"]').val($('.super-create-form input[name="wizard_form_thanks_title"]').val());
            $('.super-create-form textarea[name="form_thanks_description"]').val($('.super-create-form textarea[name="wizard_form_thanks_description"]').val());

        }
        var $img_preview = $theme+'-'+$size;
        if($icon=='yes') $img_preview = $img_preview+'-icon';
        var $img_preview_url = $('.super-wizard-preview img').attr('data-preview-url')+'assets/images/wizard-preview/'+$img_preview+'.png';
        $('.super-wizard-preview img').attr('src', $img_preview_url);
    }

    // @since 3.1.0 - trigger undo/redo after _super_elements was changed
    SUPER.insertAfter = function(referenceNode, newNode) {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
    }
    SUPER.trigger_redo_undo = function() {

        // Add code to textarea
        var code = document.querySelector('textarea[name="_super_elements"].active');
        var el = document.createElement("textarea");
        el.value = code.value;
        el.name = '_super_elements';
        el.className = 'active';
        code.className = '';
        code.parentNode.insertBefore(el, code.nextSibling);

        // Disable/Enable redo/undo buttons
        var $code = $('textarea[name="_super_elements"].active');
        if($code.parent().children('textarea').length>1){
            if($('textarea[name="_super_elements"].active').index()==0){
                $('.super-form-builder-actions .super-undo').addClass('super-disabled');
            }else{
                $('.super-form-builder-actions .super-undo').removeClass('super-disabled');
            }
            if($('textarea[name="_super_elements"].active').index()==($('.super-debug textarea[name="_super_elements"]').length-1)){
                $('.super-form-builder-actions .super-redo').addClass('super-disabled');
            }else{
                $('.super-form-builder-actions .super-redo').removeClass('super-disabled');
            }
        }
    }

    // @since 3.7.0 - function for random name generation when duplicate action button is clicked
    SUPER.generate_new_field_name = function() {
        var $field_name = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        for (var i = 0; i < 5; i++) {
            $field_name += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        // First check if this fieldname already exists inside builder
        if($('.super-preview-elements .super-shortcode-field[name="'+$field_name+'"]').length){
            var $field_name = SUPER.generate_new_field_name();   
        }
        return 'field_'+$field_name;
    }


    jQuery(document).ready(function ($) {
        
        var $doc = $(document);

        // Highlight element that we want to edit
        $doc.on('mouseenter', '.super-preview-elements .super-element:not(.super-highlighted)', function(e){
            $('.super-preview-elements').find('.super-drop-before, .super-drop-inside, .super-drop-after').remove();
            var $target = $(e.target);
            if(!$target.hasClass('super-element')){
                $target = $target.parents('.super-element:eq(0)');
            }
            if($('.super-preview-elements').hasClass('super-moving-elements')){
                $target.parents('.super-element').removeClass('super-highlighted').removeClass('super-drag-drop-here');
                $target.addClass('super-drag-drop-here');
                
                $('<div class="super-drop-before"><span>Before</span></div>').appendTo($target);
                $('<div class="super-drop-inside"><span>Inside</span></div>').appendTo($target);
                $('<div class="super-drop-after"><span>After</span></div>').appendTo($target);
            }else{
                $target.parents('.super-element').removeClass('super-highlighted');
                $target.addClass('super-highlighted');
            }
        });
        $doc.on('mouseleave', '.super-preview-elements .super-element', function(e){
            $('.super-preview-elements').find('.super-drop-before, .super-drop-inside, .super-drop-after').remove();
            $(e.currentTarget).find('.super-highlighted').removeClass('super-highlighted');
            $(e.currentTarget).removeClass('super-highlighted');
            var $target = $(e.currentTarget).parents('.super-element:eq(0)');
            if( $target.length ) {
                if($('.super-preview-elements').hasClass('super-moving-elements')){
                    $target.parents('.super-element').removeClass('super-highlighted').removeClass('super-drag-drop-here');
                    $('<div class="super-drop-before"><span>Before</span></div>').appendTo($target);
                    $('<div class="super-drop-inside"><span>Inside</span></div>').appendTo($target);
                    $('<div class="super-drop-after"><span>After</span></div>').appendTo($target);
                }else{
                    $target.addClass('super-highlighted');
                }
            }     
        });

        // @since 4.0.0 - hints/introduction
        var $skip = $('input[name="super_skip_tutorial"]').val();
        var $elements_found = $('.super-preview-elements .super-element').length;
        var $skip = 'false';
        if( ($skip!='true') && (!$elements_found) ) {
            var $git = 'https://renstillmann.github.io/super-forms/#/';
            var $timeout = 0;
            var $margin = 0;
            var $timeout_s = 400;
            var $event = 'next';
            var $showSkip = false;
            var $showNext = true;
            var $tags_allowed = '<span class="super-tip">You are allowed to use {tags} for this setting,<br />for more information about tags refer to the documentation section:<br /><a target="blank" href="'+$git+'tags-system">Tags system</a></span>';


            // Check if field `wizard_title` exists
            if($('input[name="wizard_title"]').length){
                var $super_hints = new SUPER.EnjoyHint({});
                var $super_hints_steps = [
                    {
                        selector: '.enjoyhint_close_btn',
                        shape: 'circle',
                        radius: 50,
                        nextButton : {text: "Start"},
                        description: '<h1>Hello! This is a short tutorial to get you up and running with Super Forms. Please click "Start" to begin the tutorial :)</h1><span class="super-tip">If you wish to skip the tutorial, you can skip it by clicking the close button</span><span class="super-tip">We strongly suggest you complete this step by step guide. It will help you get started nicely and quickly without any issues.</span><label class="tutorial-do-not-show-again"><input type="checkbox" name="tutorial_do_not_show_again" />Do not show me this tuturial again.</label>',
                    },
                    {
                        onBeforeStart: function() {
                            $('input[name="wizard_title"]').keydown(function(e) {
                                if( (e.keyCode == 13) && ($(this).val() !== '') ) {
                                    $super_hints.trigger('next');
                                }
                            });
                        },
                        selector: 'input[name="wizard_title"]',
                        event: 'form_title_entered',
                        event_type: 'custom',
                        description: '<h1>Enter your form title and press Enter.</h1>',
                    },
                    {
                        selector: '.super-theme-style-wizard',
                        event: 'click',
                        description: '<h1>Choose a form theme.</h1>',
                    },
                    {
                        selector: '.super-field-size-wizard',
                        event: 'click',
                        description: '<h1>Now choose a field size for your form elements.</h1>',
                    },
                    {
                        selector: '.super-theme-hide-icons-wizard',
                        event: 'click',
                        description: '<h1>Select wether or not to display icons for fields</h1><span class="super-tip">Don\'t worry, you can change all these settings at a later time</span>',
                    },
                    {
                        selector: '.super-wizard-preview',
                        description: '<h1>Here you can preview your form and see how it will look on the front-end of your website</h1><span class="super-tip">Note that this is an example only, and the elements are just for demonstration purpose only. You will soon build your very own form with your own elements.</span>',
                    },
                    {
                        selector: '.super-wizard-settings .super-tabs > li:eq(1)',
                        event: 'click',
                        showNext: false,
                        description: '<h1>Click on the "Admin email" TAB to change how your admin emails are send</h1><span class="super-tip">By default this email will be send to the wordpress admin email address, but you can change this to any email address.</span>',
                    },
                    {
                        selector: 'input[name="wizard_header_to"]',
                        description: '<h1>Enter the email address where admin emails should be send to</h1>' + $tags_allowed,
                    },

                    {
                        selector: 'input[name="wizard_header_from"]',
                        description: '<h1>Enter the email address where the email was send from</h1>' + $tags_allowed,
                    },

                    {
                        selector: 'input[name="wizard_header_from_name"]',
                        description: '<h1>Enter the name of your company or website</h1>' + $tags_allowed,
                    },

                    {
                        selector: 'input[name="wizard_header_subject"]',
                        description: '<h1>Enter the email subject that relates to this form</h1>' + $tags_allowed,
                    },
                    {
                        selector: 'textarea[name="wizard_email_body_open"]',
                        description: '<h1>Here you can enter a short description that will be placed at the top of your admin email</h1><span class="super-tip">The email body itself can be changed under the "Form Settings" panel on the builder page, which we will be covering at a later time in this tutorial.</span><span class="super-tip">The email body itself will by default simply loop all the user input that was submitted by the user. You can of course write your custom email body if you require to do so.</span>' + $tags_allowed,
                    },
                    {
                        selector: '.super-wizard-settings .super-tabs > li:eq(2)',
                        event: 'click',
                        showNext: false,
                        description: '<h1>Click on the "Confirmation email" TAB to change how confirmation emails are send</h1><span class="super-tip">By default this email will be send to the user who submitted the form if an email address was provided</span>',
                    },
                    {
                        selector: 'input[name="wizard_confirm_to"]',
                        description: '<h1>The email address where the confirmation email should be send to.</h1><span class="super-tip">By default this is set to {email} which is a <a target="_blank" href="'+$git+'tags-system">tag</a> that will automatically retrieve the email address that the user entered in the form.</span><span class="super-tip">You can seperate emails with comma\'s to send to multiple addresses</span>' + $tags_allowed,
                    },
                    {
                        selector: 'input[name="wizard_confirm_from"]',
                        description: '<h1>Enter the email address where the email was send from</h1>' + $tags_allowed,
                    },
                    {
                        selector: 'input[name="wizard_confirm_from_name"]',
                        description: '<h1>Enter the name of your company or website</h1>' + $tags_allowed,
                    },
                    {
                        selector: 'input[name="wizard_confirm_subject"]',
                        description: '<h1>Enter the confirmation email subject that relates to this form</h1>' + $tags_allowed,
                    },
                    {
                        selector: 'textarea[name="wizard_confirm_body_open"]',
                        description: '<h1>Here you can enter a short description that will be placed at the top of your confirmation email</h1><span class="super-tip">The email body itself can be changed under the "Form Settings" panel on the builder page, which we will be covering at a later time in this tutorial.</span><span class="super-tip">The email body itself will by default simply loop all the user input that was submitted by the user. You can of course write your custom email body if you require to do so.</span>' + $tags_allowed,
                    },
                    {
                        selector: '.super-wizard-settings .super-tabs > li:eq(3)',
                        event: 'click',
                        showNext: false,
                        description: '<h1>Click on the "Thank you message" TAB to change the Success message</h1><span class="super-tip">This message will by default be displayed to the user after they successfully submitted the form.</span>' + $tags_allowed,
                    },
                    {
                        selector: 'input[name="wizard_form_thanks_title"]',
                        description: '<h1>The Title for your thank you message</h1>' + $tags_allowed,
                    },
                    {
                        selector: 'textarea[name="wizard_form_thanks_description"]',
                        description: '<h1>The Description for your thank you message</h1><span class="super-tip">This can be used to provide some additional information that is important to the user after they successfully submitted the form.</span>' + $tags_allowed,
                    },
                    {
                        selector: '.super-button.save-wizard',
                        event: 'click',
                        showNext: false,
                        description: '<h1>Click this button to save the configuration and to start building your form</h1>',
                    },
                ];
                $.each($super_hints_steps, function(key, value){
                    if( typeof value.event === 'undefined')
                        $super_hints_steps[key]['event'] = $event;
                    if( typeof value.showSkip === 'undefined')
                        $super_hints_steps[key]['showSkip'] = $showSkip;
                    if( typeof value.showNext === 'undefined')
                        $super_hints_steps[key]['showNext'] = $showNext;
                    if( typeof value.timeout === 'undefined')
                        $super_hints_steps[key]['timeout'] = $timeout;
                    if( typeof value.margin === 'undefined')
                        $super_hints_steps[key]['margin'] = $margin;
                });
                $super_hints.set($super_hints_steps);
                $super_hints.run();
            }else{
                var $super_hints = new SUPER.EnjoyHint({});
                var $super_hints_steps = [
                    {
                        selector: '.super-preview-elements',
                        description: '<h1>This is your "Canvas" where you will be dropping all your "Elements"</h1><span class="super-tip">"Elements" can be fields, but also HTML elements and columns. Basically anything that can be dragged and dropped onto the canvas is a so called element.</span><label class="tutorial-do-not-show-again"><input type="checkbox" name="tutorial_do_not_show_again" />Do not show me this tuturial again.</label>',
                    },
                    {
                        selector: '.super-element.super-form-elements',
                        event: 'click',
                        description: '<h1>Let\'s open up the "Form Elements" panel by clicking on it</h1>',
                    },
                    {
                        selector: '.super-element.super-form-elements .super-elements-container',
                        description: '<h1>Here you can find all "Form Elements"</h1><span class="super-tip">Form elements are elements that a user can enter data into (also referred to as "user input"). As you can see there is a variety of form elements to choose from to create any type of form you want.</span>',
                        timeout: $timeout_s
                    },
                    {
                        onBeforeStart: function() {
                            $doc.find('.super-element.draggable-element.super-shortcode-email').on('mouseleave',function(e){
                                if( $(this).hasClass('pep-start') ) {
                                    $super_hints.trigger('next');
                                }
                            });
                        },
                        showNext: false,
                        selector: '.super-element.super-form-elements .super-elements-container .super-shortcode-email',
                        description: '<h1>Let\'s drag the "Email Address" field on to your "Canvas"</h1>',
                    },
                    {
                        onBeforeStart: function() {
                            // Keep searching for element until we found it, then automatically go to next step
                            var loop = setInterval(function() {
                                if($('.super-element .super-field-wrapper input[name="email"]').length){
                                    $super_hints.trigger('next');
                                    clearInterval(loop);
                                }
                            }, 100);
                        },
                        selector: '.super-preview-elements',
                        showNext: false,
                        description: '<h1>Drop the element on to your "Canvas"</h1>',
                    },
                    {
                        selector: '.super-element-title .super-title > input',
                        description: '<h1>Here you can quickly change the "Unique field name" of your field</h1><span class="super-tip">The unique field name relates to the user input. The {email} <a target="_blank" href="'+$git+'tags-system">tag</a> in this case would retrieve the entered email address of the user which you can then use within your custom emails, HTML elements and <a target="_blank" href="'+$git+'variable-fields">Variable fields</a> or inside your email subjects or other settings that support the use of {tags}.</span>',
                    },
                    {
                        onBeforeStart: function() {
                            $('.super-element-actions .minimize').css( 'pointer-events', 'none' );
                            $('.super-element-actions .delete').css( 'pointer-events', 'none' );
                        },
                        selector: '.super-element-actions .minimize',
                        radius: 10,
                        shape: 'circle',
                        description: '<h1>Here you can minimize your element</h1><span class="super-tip">This comes in handy especially when working with large forms. To benefit from this feature make sure you use columns to group your elements. With columns you can minimize a set of elements at once to make building forms even easier, faster and better manageable.</span>',
                    },
                    {
                        onBeforeStart: function() {
                            $('.super-element-actions .minimize').css( 'pointer-events', '' );
                            $('.super-element-actions .delete').css( 'pointer-events', '' );
                        },
                        selector: '.super-element-actions .delete',
                        radius: 10,
                        event: 'click',
                        shape: 'circle',
                        description: '<h1>Click on the delete icon and delete this element</h1><span class="super-tip">Removing a "Layout Element" (<a target="_blank" href="'+$git+'columns">Column</a> or <a target="_blank" href="'+$git+'multi-parts">Multi-part</a>) will also delete all it\'s inner elements along with it.</span><span class="super-tip">Don\'t worry, we will cover Columns and Multi-part elements very soon!</span>',
                    },
                    {
                        selector: '.super-form-builder-actions .super-undo',
                        event: 'click',
                        shape: 'circle',
                        description: '<h1>Undo previous change, click and undo your previous change to get back our element</h1><span class="super-tip">If you accidently deleted an element and want to get it back or when you moved an element where you did not want it to be moved to by accident, then you can undo your latest change with this button.</span><span class="super-tip">You can undo/redo any changes you made to your form that affected elements.</span><span class="super-tip">Please understand that the Undo/Redo buttons act like scrolling through micro back-ups of your form (which aren\'t really saved), so after a page refresh you can no longer undo any previously made changes).</span>',
                    },
                    {
                        onBeforeStart: function() {
                            $('.super-form-builder-actions .super-redo').css( 'pointer-events', 'none' );
                        },
                        selector: '.super-form-builder-actions .super-redo',
                        shape: 'circle',
                        description: '<h1>Redo previous change</h1><span class="super-tip">Does the same thing as undo but opposite.</span>',
                    },
                    {
                        onBeforeStart: function() {
                            $('.super-form-builder-actions .super-backups').css( 'pointer-events', 'none' );
                            $('.super-form-builder-actions .super-redo').css( 'pointer-events', '' );
                        },
                        selector: '.super-form-builder-actions .super-backups',
                        shape: 'circle',
                        description: '<h1>Load or restore to previous backups</h1><span class="super-tip">Backups are automatically made when saving your form, so whenever you want to go back in history you can restore directly to a previous backup that was automatically made for you.</span>',
                    },
                    {
                        onBeforeStart: function() {
                            $('.super-form-builder-actions .super-backups').css( 'pointer-events', '' );
                        },
                        selector: '.super-form-builder-actions .super-minimize-toggle',
                        event: 'click',
                        shape: 'circle',
                        description: '<h1>Let\'s minimize all our elements, we only have 1 element but for the demonstration purpose this doesn\'t matter right now ;)</h1><span class="super-tip">This comes in handy especially when working with large forms. To benefit from this feature make sure you use columns to group your elements. With columns you can minimize a set of elements at once to make building forms even easier, faster and better manageable.</span></span>',
                    },
                    {
                        selector: '.super-form-builder-actions .super-maximize-toggle',
                        event: 'click',
                        shape: 'circle',
                        description: '<h1>Maximizing all elements</h1><span class="super-tip">Whenever you working with large forms and used the minimize button, you can maximize all of your elements at once to quickly find the element that you need to edit.</span>',
                    },
                    {
                        selector: '.super-element-actions .move',
                        radius: 10,
                        shape: 'circle',
                        description: '<h1>Moving your element can be done via this button</h1><span class="super-tip">Drag & Drop your element into a different location or inside a different layout element with ease.</span>',
                    },
                    {
                        selector: '.super-element-actions .duplicate',
                        event: 'click',
                        radius: 10,
                        shape: 'circle',
                        description: '<h1>Duplicate this element</h1><span class="super-tip">Duplicating elements that you already created will speed up your building process! When duplicating Columns or Multi-parts all inner elements will be duplicated along with them, making life even easier :)</span>',
                    },
                    {
                        selector: '.super-element-actions .edit',
                        radius: 10,
                        event: 'click',
                        shape: 'circle',
                        description: '<h1>Click on the pencil icon to edit this element</h1><span class="super-tip">All elements can be edited, and each element will have it\'s very own settings and features. </span>',
                    },
                    {
                        selector: '.super-element.super-element-settings',
                        description: '<h1>Here you can find all the settings for the element you are editing</h1><span class="super-tip">By default the General TAB is opened where you will find the most commonly used settings that you will often be changing.</span>',
                        timeout: $timeout_s
                    },
                    {
                        selector: '.super-element.super-element-settings .super-element-settings-tabs > select',
                        event: 'change',
                        showNext: false,
                        description: '<h1>We have devided all element settings into sections which you can choose from via this dropdown, Open the dropdown and switch to a different section to find out about all the other features and settings for the element you are editing.</h1><span class="super-tip">Remember that all elements have different settings and features, so make sure to explore them all!</span><span class="super-tip">Note that the Email Address element that we added to our form, is a <a target="_blank" href="'+$git+'text">Text field</a>. It is a predefined element that basically has the <a target="_blank" href="'+$git+'special-validation?id=email-address">Email address validation</a> enabled by default. There are several other predefined elements for you just to make building even easier for you.',
                    },
                    {
                        selector: '.super-element.super-element-settings',
                        description: '<h1>Perfect! Now you know how to edit elements and how to find all settings and features available for each element you edit.</h1>',
                    },
                    {
                        selector: '.super-element-settings .tab-content.active .super-tooltip',
                        shape: 'circle',
                        radius: 20,
                        description: '<h1>Not sure what a field is used for, just hover over the question icon to find out more information about it.</h1>',
                    },
                    {
                        selector: '.super-element.super-layout-elements',
                        event: 'click',
                        description: '<h1>Let\'s explore the rest of Super Forms shall we? Open up the "Layout Elements" panel by clicking on it</h1>',
                    },
                    {
                        selector: '.super-element.super-layout-elements .super-elements-container',
                        description: '<h1>These are your "Layout Elements"</h1><span class="super-tip">The <a target="_blank" href="'+$git+'columns">Columns (Grid Element)</a> can be used to create the layout of your form.</span><span class="super-tip">You can use columns to put fields next to eachother and to do <a target="_blank" href="'+$git+'conditional-logic">Conditional Logic</a>.</span><span class="super-tip">A column can also be used to create <a target="_blank" href="'+$git+'columns?id=dynamic-add-more">Dynamic fields</a> that can be duplicated by users. This way a set of fields can be dynamically added by clicking on a "+" icon.</span><span class="super-tip">Columns can be nested inside of each other as many times as you wish, they can also be inserted into a <a target="_blank" href="'+$git+'multi-parts">Multi-part</a> element.</span><span class="super-tip">The <a target="_blank" href="'+$git+'multi-parts">Multi-part</a> element can be used to split a form into multiple parts (also called steps). For each step you will have to add a new Multi-part element with inside the elements that belong to this particular step.</span>',
                        timeout: $timeout_s
                    },
                    {
                        selector: '.super-element.super-html-elements',
                        event: 'click',
                        description: '<h1>Now open the "HTML Elements" panel</h1>',
                    },
                    {
                        selector: '.super-element.super-html-elements .super-elements-container',
                        description: '<h1>Here you can find all HTML elements</h1><span class="super-tip">HTML elements are elements that users can not change or alter (they are fixed html items that do not require user input). However you can make some elements dynamically change with the use of <a target="_blank" href="'+$git+'conditional-logic">Conditional Logic</a> and the use of <a target="_blank" href="'+$git+'variable-fields">Variable fields</a> and the <a target="_blank" href="'+$git+'tags-system">{tags} system</a>. These elements can help you to change the aesthetics of your form.</span>',
                        timeout: $timeout_s
                    },
                    {
                        selector: '.super-element.super-form-settings',
                        event: 'click',
                        description: '<h1>Open the "Form Settings" panel to edit form settings</h1>',
                    },
                    {
                        selector: '.super-element.super-form-settings .super-elements-container',
                        description: '<h1>Here you can change all the "Form Settings" which will only apply to this specific form</h1><span class="super-tip">Under [Super Forms > Settings] (WordPress menu) you will find all your global settings that will be applied to all of your forms when creating a new form. After creating a form you can change each of these form settings over here. If both the global setting and form setting are the same the setting will not be saved for the form and instead the global setting will be used now and in the future until they differ from eachother.</span><span class="super-tip"><strong>Important to understand:</strong> If both the global setting and form setting are the same the setting will basically not be saved, but instead the global setting will be used by default now and in the future until they differ from eachother. This means that when you change a global setting at a later time it will affect all previously created forms that where initially setup with this exact same setting. This way you can control all of your forms if required from a global point of view.</span>',
                        timeout: $timeout_s
                    },
                    {
                        selector: '.super-form-settings-tabs > select',
                        event: 'change',
                        showNext: false,
                        description: '<h1>We have devided all form settings into sections which you can choose from via this dropdown, Open the dropdown and switch to a different section to find out about all the other settings that you can change with Super Forms</h1>',
                    },
                    {
                        selector: '.super-element.super-form-settings .super-elements-container',
                        description: '<h1>Great, now you know how to change all the settings related to a specific form!</h1><span class="super-tip">Please note that in some cases you have to change settings under [Super Forms > Settings] (WordPress menu). For instance if you require to setup SMTP you can do it only via the global settings and not individually per form. The same goes for reCAPTCHA API key and secret. For some Add-ons you will also only find the settings under [Super Forms > Settings] and not under the "Form Settings" panel on the builder page.</span>',
                        timeout: $timeout_s
                    },
                    {
                        selector: '.form-name',
                        description: '<h1>Here you can change the name of your form</h1><span class="super-tip">Always choose a name that relates to the purpose of the form itself.</span><span class="super-tip">The "Form name" is for your own reference only, and is not visible to anyone other than you and other WordPress admins.</span>',
                    },
                    {
                        selector: '.super-switch-forms',
                        description: '<h1>Here you can easily switch to a different form that you previously created</h1><span class="super-tip">A list will open with previously created forms to quickly switch to.</span>',
                    },
                    {
                        onBeforeStart: function() {
                            $('.super-switch-forms').removeClass('active');
                        },
                        selector: '.super-get-form-shortcodes',
                        description: '<h1>This is the [shortcode] of your form. You can display your form by copy pasting the shortcode to any of your posts/pages.</h1><span class="super-tip">You can add your shortcode in posts, pages and widgets (e.g: sidebars or in your footer). Anywhere within your site where your theme supports shortcodes you can basically display your fomr. In case you want to read more about how to build and publish your first form you can read the <a target="_blank" href="'+$git+'build">Documentation</a></span>',
                    },
                    {
                        selector: '.super-actions .save',
                        description: '<h1>You can save your form simply by clicking the "Save" button</h1>',
                    },
                    {
                        selector: '.super-actions .clear',
                        description: '<h1>If you want to start with a blank form you can use the "Clear" button</h1><span class="super-tip">Please note that this will erase your current work in progress and will delete all the elements that are currently on the canvas.</span>',
                    },
                    {
                        selector: '.super-actions .delete',
                        onBeforeStart: function() {
                            $('.super-actions .delete').css( 'pointer-events', 'none' );
                        },
                        description: '<h1>Here you can delete your form</h1><span class="super-tip">This will delete the form itself allong with it\'s Elements, Settings and all it\'s backups. It will not delete the associated Contact Entries that where created by the form.</span>',
                    },
                    {
                        onBeforeStart: function() {
                            $('.super-actions .delete').css( 'pointer-events', '' );
                            $('.enjoyhint_close_btn').css('display','none');
                        },
                        selector: '.super-actions .preview.switch',
                        description: '<h1>To see how your form will look on the front-end you can click the "Preview" button</h1><span class="super-tip">You can also preview the form on mobile and tablet devices to test it\'s responsiveness.</span>',
                    },
                    {
                        selector: '.super-actions > label:last',
                        description: '<h1>(For Developers Only) Enable this whenever you require to be able to save a form that has duplicate field names</h1><span class="super-tip">Whenever you are a developer and require the need to save a form that consists of duplicate field names, then you have to enable this setting. By default Super Forms prevents saving a form that contains duplicate field names.</span>',
                    },
                    {
                        selector: '.wp-submenu a[href*="page=super_marketplace"]',
                        description: '<h1>You finished the tutorial! Now you know how to navigate around Super Forms page and create awesome forms with it.<br /><br />Please check out the Marketplace with awesome one click install forms that can get you up and running in no time!</h1><span class="super-tip">We hope you will enjoy the plugin, if you have future questions do not hesitate to contact support!</span><span class="super-tip">Don\'t forget to checkout the <a target="_blank" href="'+$git+'">Documentation</a> whenever you need more information about the plugin and all of it\'s features :)</i></span>',
                        nextButton : {
                            text: "Finish"
                        },
                    },
                ];
                $.each($super_hints_steps, function(key, value){
                    if( typeof value.event === 'undefined')
                        $super_hints_steps[key]['event'] = $event;
                    if( typeof value.showSkip === 'undefined')
                        $super_hints_steps[key]['showSkip'] = $showSkip;
                    if( typeof value.showNext === 'undefined')
                        if($super_hints_steps[key]['event']=='click'){
                            $super_hints_steps[key]['showNext'] = false;
                        }else{
                            $super_hints_steps[key]['showNext'] = $showNext;
                        }
                    if( typeof value.timeout === 'undefined')
                        $super_hints_steps[key]['timeout'] = $timeout;
                    if( typeof value.margin === 'undefined')
                        $super_hints_steps[key]['margin'] = $margin;
                });
                $super_hints.set($super_hints_steps);
                $super_hints.run();
            }
        }

        // @since 4.0.0 - update conditional checks values
        $doc.on('change keydown keyup blur','.super-conditional-check input[type="text"], .super-conditional-check select',function(){
            var $parent = $(this).parents('.super-conditional-check:eq(0)');
            var $value = '';
            $parent.children('input[type="text"], select').each(function(){
                if($(this).index()==0){
                    $value += $(this).val();
                }else{
                    $value += ',' + $(this).val();
                }
            });
            if($value==',') $value = '';
            $parent.children('input[type="hidden"]').val($value);
        });

        // @since 4.0.0 - skip tutorial if checkbox is checked.
        $doc.on('click', '.tutorial-do-not-show-again', function(){
            var $status = $(this).children('input').is(':checked');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_tutorial_do_not_show_again',
                    status: $status
                }
            });
        });
        
        // @since 4.1.0 - switch to a different builder type
        $doc.on('click', '.super-form-builder-actions .super-builder-tabs > span', function(){
            var $button = $(this);
            if($button.hasClass('super-active')) return false;
            $button.addClass('super-loading');
            var $type = $button.attr('data-type');
            SUPER.save_form( $('.super-actions .save'), 2, $type );
        });

        // @since 3.1.0 - backup history
        $doc.on('click', '.super-form-builder-actions .super-backups', function(){
            $('.super-backup-history, .super-first-time-setup-bg').addClass('super-active')
            $('.super-backup-history').addClass('super-loading');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_restore_backup',
                    form_id: $('.super-create-form input[name="form_id"]').val()
                },
                success: function (data) {
                    $('.super-wizard-backup-history > ul').remove();
                    $('.super-wizard-backup-history').find('i').remove();
                    $(data).appendTo($('.super-wizard-backup-history'));
                },
                complete: function(){
                    $('.super-backup-history').removeClass('super-loading');
                }
            });
        });
        $doc.on('click', '.super-wizard-backup-history > ul > li > span', function(){
            $(this).html('Restoring...').addClass('loading');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_restore_backup',
                    form_id: $('.super-create-form input[name="form_id"]').val(),
                    backup_id: $(this).parent('li').attr('data-id')
                },
                success: function (data) {
                    location.reload();
                }
            });
        });
        $doc.on('click', '.super-wizard-backup-history > ul > li > i', function(){
            var $parent = $(this).parents('ul:eq(0)');
            var $delete = confirm(super_create_form_i18n.confirm_deletion);
            if($delete == true) {
                var $backup = $(this).parent();
                $backup.html(super_create_form_i18n.deleting);
                $.ajax({
                    type: 'post',
                    url: ajaxurl,
                    data: {
                        action: 'super_delete_backups',
                        backup_id: $backup.data('id')
                    },
                    success: function (data) {
                        $backup.slideUp("normal", function(){
                            $(this).remove();
                            if($parent.children('li').length==0){
                                $('.super-wizard-backup-history > ul').remove();
                                $('<i>'+super_create_form_i18n.no_backups_found+'</i>').appendTo($('.super-wizard-backup-history'));
                            }
                        });
                    }
                });
            }

        });
        $doc.on('click', '.delete-backups', function(){
            var $old_html = $(this).html();
            var $button = $(this);
            $button.html(super_create_form_i18n.deleting).addClass('loading');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_delete_backups',
                    form_id: $('.super-create-form input[name="form_id"]').val()
                },
                success: function (data) {
                    $('.super-wizard-backup-history > ul').remove();
                    $('<i>'+super_create_form_i18n.no_backups_found+'</i>').appendTo($('.super-wizard-backup-history'));
                    $button.html($old_html).removeClass('loading');
                }
            });
        });

        // @since 4.0.0 - minimize toggle button to toggle all elements minimized or maximize
        $doc.on('click', '.super-form-builder-actions .super-minimize-toggle, .super-form-builder-actions .super-maximize-toggle', function(){
            var $minimize = 'yes';
            if( $(this).hasClass('super-maximize-toggle') ) {
                $minimize = 'no';
            }
            $('.super-preview-elements .super-element').each(function(){
                if( $minimize=='yes' ) {
                    $(this).attr('data-minimized', 'yes').addClass('super-minimized');
                }else{
                    $(this).attr('data-minimized', 'no').removeClass('super-minimized');
                }
            });
            SUPER.init_resize_element_labels();
            SUPER.init_drag_and_drop();
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
        });

        // @since 3.1.0 - undo/redo buttons
        $doc.on('click', '.super-form-builder-actions .super-redo:not(.super-disabled)', function(){
            var $elements = $('textarea[name="_super_elements"].active').next();
            if($elements.index()<0){
                $('.super-form-builder-actions .super-redo').addClass('super-disabled');
                return false;
            }
            $('textarea[name="_super_elements"]').removeClass('active');
            $elements.addClass('active');

            var $button = $(this);
            $button.addClass('super-loading');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_undo_redo',
                    form_id: $('.super-create-form input[name="form_id"]').val(),
                    elements: $elements.val()
                },
                success: function (result) {
                    $('.super-preview .super-preview-elements').html(result);
                    $('.super-form-builder-actions .super-undo').removeClass('super-disabled');
                    if($('textarea[name="_super_elements"].active').index()==($('.super-debug textarea[name="_super_elements"]').length-1)){
                        $('.super-form-builder-actions .super-redo').addClass('super-disabled');
                    }
                    SUPER.init_resize_element_labels();
                },
                complete: function(){
                    $button.removeClass('super-loading');
                }
            });
        });
        $doc.on('click', '.super-form-builder-actions .super-undo:not(.super-disabled)', function(){
            
            var $current = $('textarea[name="_super_elements"].active');
            var $elements = $current.prev();

            // First get index of last element
            var  $last = $('textarea[name="_super_elements"]:last-child').index();

            // If last element index is active, and undo is pressed, skip the previous element
            if( $last==$current.index() ) {
                var $elements = $current.prev().prev();
            }

            if($elements.index()<0){
                $('.super-form-builder-actions .super-undo').addClass('super-disabled');
                return false;
            }
            $('textarea[name="_super_elements"]').removeClass('active');
            $elements.addClass('active');

            var $button = $(this);
            $button.addClass('super-loading');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_undo_redo',
                    form_id: $('.super-create-form input[name="form_id"]').val(),
                    elements: $elements.val()
                },
                success: function (result) {
                    $('.super-preview .super-preview-elements').html(result);
                    $('.super-form-builder-actions .super-redo').removeClass('super-disabled');
                    if($('textarea[name="_super_elements"].active').index()==0){
                        $('.super-form-builder-actions .super-undo').addClass('super-disabled');
                    }
                    SUPER.init_resize_element_labels();
                },
                complete: function(){
                    $button.removeClass('super-loading');
                }
            });
        });


        SUPER.init_drop_here_placeholder();
        SUPER.init_dragable_elements();
        SUPER.init_image_browser();

        $('.super-layout-elements .super-elements-container').css('display','block');

        SUPER.init_resize_element_labels();

        // @since 2.9.0 - Form setup wizard
        $doc.on('click', '.super-theme-style-wizard > li, .super-field-size-wizard > li, .super-theme-hide-icons-wizard > li', function(){
            var $this = $(this);
            var $parent = $this.parent();
            $parent.children('li').removeClass('super-active');
            $this.addClass('super-active');
            var $value = $this.attr('data-value');
            if($parent.hasClass('super-theme-style-wizard')) SUPER.update_wizard_preview($value, null, null, false);
            if($parent.hasClass('super-field-size-wizard')) SUPER.update_wizard_preview(null, $value, null, false);
            if($parent.hasClass('super-theme-hide-icons-wizard')) SUPER.update_wizard_preview(null, null, $value, false);
        });

        $doc.on('click', '.skip-wizard, .super-first-time-setup-bg', function(){
            $('.super-first-time-setup, .super-first-time-setup-bg').removeClass('super-active');
        }); 

        $doc.on('click', '.save-wizard', function(){
            $(this).addClass('loading').html('Saving settings...');
            SUPER.update_wizard_preview(null, null, null, true);
            $('.super-actions .save').trigger('click');
        });
        $doc.on('click', '.super-wizard-settings .super-tabs > li', function(){
            var $index = $(this).index();
            $(this).parent().children('li').removeClass('super-active');
            $(this).addClass('super-active');
            $('.super-wizard-settings .super-tab-content > li').removeClass('super-active');
            $('.super-wizard-settings .super-tab-content > li:eq('+$index+')').addClass('super-active');
        });


        // @since 1.5
        $doc.on('change keyup blur','.super-element.super-element-settings input[name="name"]',function(){
            var $editing = super_get_editing_element();
            var $tag = $editing.data('shortcode-tag');
            if( $tag!='button' ) {
                var $value = $(this).val().replace(/\s+/gi,'_');
                var $value = $value.replace(/ /g,"_");
                var $value = $value.replace(/\//g,"");
                var $value = $value.replace(/[^a-zA-Z0-9-_\.]+/g,"");
                var $value = $value.replace(/\.+/g, "_");
                var $value = $value.replace(/[--]+/g, "-");
                var $value = $value.replace(/[__]+/g, "_");
                $(this).val($value);

                // @since 3.7.0 - change unique field name on the fly
                $('.super-element.editing .super-title > input').val($value);
            }
        });

        $doc.on('change','.super-create-form .super-element-header .super-element-label > input',function(){
            var $this = $(this);
            var $value = $this.val();
            var $span = $this.parent().children('span');
            $span.html($value);
            $this.attr('value',$value);
            var $width = $span.outerWidth(true);
            $this.parent().css('width', $width+'px').css('margin-left', '-'+($width/2)+'px');
            var $parent = $this.parents('.super-element:eq(0)');
            var $data = $parent.children('textarea[name="element-data"]').val();
            var $tag = $parent.data('shortcode-tag');
            var $data = JSON.parse($data);
            if( ($tag=='column') || ($tag=='multipart') ) {
                $data.label = $value;
            }
            var $data = JSON.stringify($data);
            $parent.children('textarea[name="element-data"]').val($data);
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
        });

        $doc.on('click','.super-element-actions .duplicate',function(){
            var $parent = $(this).parents('.super-element:eq(0)');
            $parent.find('.tooltip').remove();
            var $new = $parent.clone();
            $new.removeClass('super-highlighted');

            // @since 3.7.0 - bug fix remove editing class when duplicating column with active editing element inside
            $new.find('.super-element.editing').removeClass('editing');

            // @since 3.7.0 - automatically rename duplicated fields for more user-friendly work flow
            $new.find('.super-shortcode-field').each(function(){
                var $old_name = $(this).attr('name');
                var $new_field_name = SUPER.generate_new_field_name();
                $(this).attr('name', $new_field_name);
                var $parent = $(this).parents('.super-element:eq(0)');
                $parent.find('.super-title > input').val($new_field_name);
                var $element_data_field = $parent.children('textarea[name="element-data"]');
                var $element_data = $element_data_field.val();
                var $element_data = $element_data.replace('"name":"'+$old_name+'"', '"name":"'+$new_field_name+'"');
                $element_data_field.val($element_data);
            });
            $new.removeClass('editing');
            $new.insertAfter($parent);
            $new.slideUp(0);
            $new.slideDown(300);
            SUPER.init_drag_and_drop();
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
            super_generate_first_column_classes(0, 0);
        });

        // @since 3.7.0 - change unique field name on the fly
        var super_title_timeout = null;
        $doc.on('change', '.super-element-title .super-title > input', function(){
            var $this = $(this);
            var $parent = $this.parents('.super-element:eq(0)');
            var $old_name = $parent.find('.super-shortcode-field').attr('name');
            var $new_field_name = $this.val();
            var $new_field_name = $this.val().replace(/\s+/gi,'_');
            var $new_field_name = $new_field_name.replace(/ /g,"_");
            var $new_field_name = $new_field_name.replace(/\//g,"");
            var $new_field_name = $new_field_name.replace(/[^a-zA-Z0-9-_\.]+/g,"");
            var $new_field_name = $new_field_name.replace(/\.+/g, "_");
            var $new_field_name = $new_field_name.replace(/[--]+/g, "-");
            var $new_field_name = $new_field_name.replace(/[__]+/g, "_");
            $this.val($new_field_name);
            $parent.find('.super-shortcode-field').attr('name', $new_field_name);
            var $element_data_field = $parent.children('textarea[name="element-data"]');
            var $element_data = $element_data_field.val();
            var $element_data = $element_data.replace('"name":"'+$old_name+'"', '"name":"'+$new_field_name+'"');
            $element_data_field.val($element_data);
            if($parent.hasClass('editing')){
                $('.super-elements-container .field .element-field[name="name"]').val($new_field_name);
            }
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
        });

        $doc.on('click', '.super-element-actions .minimize', function(){
            var $this = $(this).parents('.super-element:eq(0)');
            var $minimized = $this.attr('data-minimized');
            if( $minimized === 'undefined' ) $minimized = 'no';
            if($minimized=='yes'){
                $this.attr('data-minimized', 'no').removeClass('super-minimized');
            }else{
                $this.attr('data-minimized', 'yes').addClass('super-minimized');
            }
            SUPER.init_resize_element_labels();
            SUPER.init_drag_and_drop();
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
        });
        $doc.on('click', '.super-element-actions .delete', function(){
            $(this).parents('.super-element:eq(0)').next('.super-element').addClass('super-highlighted');
            $(this).parents('.super-element:eq(0)').remove();
            SUPER.init_drag_and_drop();
            SUPER.regenerate_element_inner($('.super-preview-elements'), '', 1);
            super_generate_first_column_classes(0, 0);
            cancel_update();
        });

        $doc.on('click','.super-switch-forms',function(){
            var $this = $(this);
            if($this.hasClass('active')){
                $this.children('.fa').removeClass('fa-chevron-up').addClass('fa-chevron-down');
                $this.removeClass('active');
                $this.children('ul').slideUp(300);
            }else{
                $this.children('.fa').removeClass('fa-chevron-down').addClass('fa-chevron-up');
                $this.addClass('active');
                $this.children('ul').slideDown(300);
            }
        });
        $doc.on('mouseleave','.super-switch-forms ul',function(){
            var $this = $(this).parent();
            $this.children('.fa').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            $this.removeClass('active');
            $this.children('ul').slideUp(300);
        });

        $doc.on('change','.super-form-settings-tabs > select, .super-element-settings-tabs > select',function(){
            var $parent = $(this).parents('.super-elements-container:eq(0)');
            $parent.children('.tab-content').removeClass('active');
            $parent.children('.tab-content:eq('+($(this).val())+')').addClass('active');

            var $parent = $(this).parents('.super-edit-element-panel:eq(0)');
            $parent.children('.tab-content').removeClass('active');
            $parent.children('.tab-content:eq('+($(this).val())+')').addClass('active');
        });
        
        function cancel_update(){
            $('.super-preview-elements .super-element').removeClass('editing');
            $('.super-element.super-element-settings .super-elements-container').html('<p>'+super_create_form_i18n.not_editing_an_element+'</p>');
        }

        $doc.on('click','.super-element-settings .cancel-update',function(){
            cancel_update();
        });

        $doc.on('click', '.super-checkbox input[type="checkbox"]',function(){
            var $this = $(this);
            var $parent = $this.parents('.super-checkbox:eq(0)');
            var $field = $parent.find('.element-field');
            var $selected = '';
            var $counter = 0;
            $parent.find('input[type="checkbox"]').each(function(){
                if($(this).prop('checked')==true){
                    if($counter==0){
                        $selected += $(this).val();
                    }else{
                        $selected += ','+$(this).val();
                    }
                    $counter++;
                }
            });
            $field.val($selected.toString());
        });

        $doc.on('click','.super-elements .super-element h3',function(){
            $(this).parent().children('.super-elements-container').slideToggle();
            $(this).parent().siblings().children().next('.super-elements-container').slideUp();
            return false;
        });
        
        $doc.on('click','.super-create-form .super-actions .clear',function(){
            var $clear = confirm(super_create_form_i18n.confirm_clear_form);
            if($clear == true) {
                $('.super-debug textarea[name="_super_elements"]').val('');
                $('.super-edit-element-panel').removeClass('super-active');
                $('.super-preview-elements > *:not(.super-edit-element-panel)').remove();
                $('.super-element.super-element-settings .super-elements-container').html('<p>'+super_create_form_i18n.not_editing_an_element+'</p>');
            }
        });

        $doc.on('click','.super-create-form .super-actions .delete',function(){
            var $delete = confirm(super_create_form_i18n.confirm_deletion);
            if($delete == true) {
                var $this = $(this);
                $this.html('<i class="fa fa-trash-o"></i>'+super_create_form_i18n.deleting);
                $.ajax({
                    type: 'post',
                    url: ajaxurl,
                    data: {
                        action: 'super_delete_form',
                        id: $('.super-create-form input[name="form_id"]').val(),
                    },
                    success: function (data) {
                        $this.html('<i class="fa fa-check"></i>Deleted!');
                        window.location.href = "edit.php?post_type=super_form";
                    }
                }); 
            }
        });

        $doc.on('click','.super-load-form .load-form',function(){
            var $confirm = confirm(super_create_form_i18n.confirm_load_form);
            if($confirm == true) {
                var $parent = $(this).parent();
                var $value = $('select[name="super-forms"]').val();
                if($value==''){
                    alert(super_create_form_i18n.alert_select_form);
                }else{
                    if(($value%1)===0) {
                        $.ajax({
                            type: 'post',
                            url: ajaxurl,
                            data: {
                                action: 'super_load_form',
                                id: $('select[name="super-forms"]').val(),
                            },
                            success: function (data) {
                                $('textarea[name="_super_elements"]').val(data);
                                SUPER.regenerate_element_inner(2);
                            }
                        });
                    }else{
                        $html = $parent.find('textarea[name="'+$value+'"]').val();
                        $('.super-debug textarea[name="_super_elements"]').html($html);
                        SUPER.regenerate_element_inner(2);
                    }
                }
            }
            return false;
        });    
        




        /*
        $doc.on('click','.super-element-actions .edit',function(){
            var $parent = $(this).parents('.super-element:eq(0)');
            if($parent.hasClass('editing')){
                // But make sure that we open up the edit panel
                $('.super-element.super-element-settings .super-elements-container').show();
                return false;
            }
            var $data = $parent.children('textarea[name="element-data"]').val();
            var $tag = $parent.data('shortcode-tag');
            var $group = $parent.data('group');
            var $data = JSON.parse($data);
            if($tag=='column'){
                $data.size = $parent.attr('data-size');
            }
            var $target = $('.super-element-settings > .super-elements-container');
            $target.html('');
            $('.super-preview-elements .super-element').removeClass('editing');
            $parent.addClass('editing');

            $('.super-element .super-elements-container').hide();
            $('.super-element.super-element-settings .super-elements-container').show().addClass('super-loading');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_load_element_settings',
                    tag: $tag,
                    group: $group,
                    data: $data,
                },
                success: function (data) {
                    $target.html(data);
                    init_form_settings_container_heights();
                },
                complete: function () {
                    SUPER.init_previously_created_fields();
                    SUPER.init_slider_field();
                    SUPER.init_tooltips();
                    SUPER.init_image_browser();
                    SUPER.init_color_pickers();
                    SUPER.init_field_filter_visibility();
                    $('.super-element.super-element-settings .super-elements-container').removeClass('super-loading');
                }
            });
            return false;
        });
        */
        
        $doc.on('click','.super-create-form .super-actions .save',function(){
            var $this = $(this);
            SUPER.save_form($this);
        });

        $doc.on('click','.super-create-form .super-actions .preview',function(){
            var $this = $('.super-create-form .super-actions .preview:eq(3)');
            if($(this).hasClass('mobile')){
                $('.super-live-preview').removeClass('tablet');
                $('.super-create-form .super-actions .preview.tablet').removeClass('active');
                $('.super-create-form .super-actions .preview.desktop').removeClass('active');    
                $(this).addClass('active');
                $('.super-live-preview').addClass('mobile');
                if(!$this.hasClass('active')){
                    $this.html('Loading...');
                    SUPER.save_form($('.super-actions .save'), 1);
                }
                SUPER.init_super_responsive_form_fields();
                return false;
            }
            if($(this).hasClass('tablet')){
                $('.super-live-preview').removeClass('mobile');
                $('.super-create-form .super-actions .preview.mobile').removeClass('active');
                $('.super-create-form .super-actions .preview.desktop').removeClass('active');
                $(this).addClass('active');
                $('.super-live-preview').addClass('tablet');
                if(!$this.hasClass('active')){
                    $this.html('Loading...');
                    SUPER.save_form($('.super-actions .save'), 1);
                }
                SUPER.init_super_responsive_form_fields();
                return false;
            }
            if($(this).hasClass('desktop')){
                $('.super-live-preview').removeClass('tablet');
                $('.super-live-preview').removeClass('mobile');
                $('.super-create-form .super-actions .preview.mobile').removeClass('active');
                $('.super-create-form .super-actions .preview.tablet').removeClass('active');
                $(this).addClass('active');
                if(!$this.hasClass('active')){
                    $this.html('Loading...');
                    SUPER.save_form($('.super-actions .save'), 1);
                }
                SUPER.init_super_responsive_form_fields();
                return false;
            } 
            if(!$this.hasClass('active')){
                $this.html('Loading...');
                SUPER.save_form($('.super-actions .save'), 1);
            }else{
                $('.super-live-preview').css('display','none');
                $('.super-preview-elements').css('display','block');
                $this.html('Preview').removeClass('active');
            }
        });


        // @since 3.8.0 - reset user submission counter
        $doc.on('click','.reset-user-submission-counter', function(){
            var $reset = confirm(super_create_form_i18n.confirm_reset_submission_counter);
            if($reset == true) {
                var $button = $(this);
                $button.addClass('loading');
                $.ajax({
                    type: 'post',
                    url: ajaxurl,
                    data: {
                        action: 'super_reset_user_submission_counter',
                        id: $('.super-create-form input[name="form_id"]').val()
                    },
                    complete: function(){
                        $button.removeClass('loading');
                    }
                });
            }
        });

        // @since 3.4.0 - reset submission counter
        $doc.on('click','.reset-submission-counter', function(){
            var $reset = confirm(super_create_form_i18n.confirm_reset_submission_counter);
            if($reset == true) {
                var $button = $(this);
                $button.addClass('loading');
                $.ajax({
                    type: 'post',
                    url: ajaxurl,
                    data: {
                        action: 'super_reset_submission_counter',
                        counter: $('.super-create-form input[name="form_locker_submission_reset"]').val(),
                        id: $('.super-create-form input[name="form_id"]').val()
                    },
                    complete: function(){
                        $button.removeClass('loading');
                    }
                });
            }
        });
        

        // @since   1.0.6
        $doc.on('focus','.super-get-form-shortcodes',function(){
            var $this = $(this);
            $this.select();
            // Work around Chrome's little problem
            $this.mouseup(function() {
                // Prevent further mouseup intervention
                $this.unbind("mouseup");
                return false;
            });
        });

        // @since 4.0.0 - export single form settings and elements
        $doc.on('click','.super-export-import-single-form .super-export',function(){
            var $button = $(this);
            $button.addClass('loading');

            var $settings = {};
            $('.super-create-form .super-form-settings .element-field').each(function(){
                var $this = $(this);
                var $hidden = false;

                // select parent based on .filter class
                var $parent = $this.parents('.field.filter');
                $parent.each(function(){
                    if($(this).css('display')=='none'){
                        $hidden = true;
                    }
                });

                // now select based on only .field class
                var $parent = $this.parents('.field');
                if($hidden==false){
                    var $name = $this.attr('name');
                    var $value = $this.val();
                    $settings[$name] = $value;
                }
            });
            var $settings = JSON.stringify($settings);

            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_export_single_form',
                    form_id: $('.super-create-form input[name="form_id"]').val(),
                    elements: $('.super-create-form textarea[name="_super_elements"].active').val(),
                    settings: $settings
                },
                success: function (data) {
                    window.location.href = data;
                },
                error: function(){
                    alert(super_create_form_i18n.export_form_error);
                },
                complete: function(){
                    $button.removeClass('loading');
                }
            });
        });

        // @since 4.0.0 - import single form settings and elements
        $doc.on('click','.super-export-import-single-form .super-import',function(){
            var $confirm = confirm(super_create_form_i18n.confirm_import);
            if($confirm == true) {
                var $button = $(this);
                var $parent = $button.parents('.field:eq(0)');
                var $form_id = $('.super-create-form input[name="form_id"]').val();

                var $file_id = $parent.find('.file-preview > li').attr('data-file');
                if(typeof $file_id === 'undefined'){
                    alert(super_create_form_i18n.import_form_choose_file);
                    return false;
                }

                var $settings = $parent.find('input[name="import-settings"]').is(':checked');
                var $elements = $parent.find('input[name="import-elements"]').is(':checked');
                if($settings == false && $elements == false){
                    alert(super_create_form_i18n.import_form_select_option);
                    return false;
                }

                $button.addClass('loading');
                $.ajax({
                    type: 'post',
                    url: ajaxurl,
                    data: {
                        action: 'super_import_single_form',
                        form_id: $form_id,
                        file_id: $file_id,
                        settings: $settings,
                        elements: $elements
                    },
                    success: function (data) {
                        var data = $.parseJSON(data);
                        if( data.error ) {
                            alert(data.error);
                        }else{
                            if( $form_id==0 ) {
                                window.location.href = "admin.php?page=super_create_form&id="+data;
                            }else{
                                location.reload();
                            }
                        }
                    },
                    error: function(){
                        alert(super_create_form_i18n.import_form_error);
                    }
                });
            }
        });
        
        // @since 4.0.0 - reset single form settings
        $doc.on('click','.super-export-import-single-form .super-reset-global-settings',function(){
            var $confirm = confirm(super_create_form_i18n.confirm_reset);
            if($confirm == true) {
                var $button = $(this);
                $button.addClass('loading');
                $.ajax({
                    type: 'post',
                    url: ajaxurl,
                    data: {
                        action: 'super_reset_form_settings',
                        form_id: $('.super-create-form input[name="form_id"]').val(),
                    },
                    success: function(data){
                        var href = window.location.href;
                        var page = href.substr(href.lastIndexOf('/') + 1);
                        var str2 = "admin.php?page=super_create_form&id";
                        if(page.indexOf(str2) == -1){
                            window.location.href = "admin.php?page=super_create_form&id="+data;
                        }else{
                            location.reload();
                        }
                    },
                    complete: function(){
                        $button.removeClass('loading');
                    }
                });
            }
        });

        // @since   1.0.6
        var $window = $(window).outerHeight(true);
        var $header = $('.super-header').outerHeight(true);
        var $viewport = $window-$header;    
        var $offset = $('.super-create-form .super-elements').offset().top;
        var $elements = $('.super-create-form .super-elements');
        var timer;
        $(window).on('load scroll resize', function() {
            var $width = $elements.outerWidth(true);
            init_form_settings_container_heights();
            var $window_width = $(window).outerWidth(true);
            if($window_width >= 983){ 
                var $scroll = $(window).scrollTop(); 
                if($scroll > 40){
                    $('.super-create-form .super-elements').css('max-width', $width+'px');
                    $('.super-create-form').addClass('sticky');
                }else{
                    $('.super-create-form .super-elements').css('max-width','');
                    $('.super-create-form').removeClass('sticky');
                }
            }else{
                $('.super-create-form .super-elements').css('max-width','');
                $('.super-create-form').removeClass('sticky');
            }
        });
        function init_form_settings_container_heights(){
            var $window_height = $(window).outerHeight(true);
            var $wp_admin_bar = $('#wpadminbar').outerHeight(true) + 55;
            var $offset_top = $('.super-create-form').offset().top;
            var $tabs_height = 0;
            var $container_padding = 50;
            var $settings_tab = 20;
            $('.super-create-form .super-elements > .super-element h3').each(function(){
                $tabs_height = $(this).outerHeight(true) + $tabs_height;  
            });
            var $max_height = $window_height - $tabs_height - $wp_admin_bar - $offset_top;
            $('.super-element-settings > .super-elements-container > .tab-content').css('max-height',$max_height-$settings_tab-$container_padding);
            $('.super-form-settings > .super-elements-container > .tab-content').css('max-height',$max_height-$settings_tab-$container_padding);
            $('.super-form-elements > .super-elements-container').css('max-height',$max_height); 
            $('.super-shortcode-fields .tabs_content').css('max-height',($window_height/2));  
        }
    });
})(jQuery);


