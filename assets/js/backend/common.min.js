// Init WP Image Browser
SUPER.init_image_browser = function(){
    $('.browse-images').each(function () {
        var $this = $(this);
        var $button = $this.children('.button');
        var $preview = $this.children('.image-preview');
        var $field = $this.children('input');
        var $frame;
        var $id = $field.val();
        $preview.on('click', 'a', function () {
            $field.val('');
            $preview.html('');
        });
        $button.on('click', function () {
            $('.ui-widget-overlay').hide();
            $this.parents('.shortcode-dialog').hide();

            // If the media frame already exists, reopen it.
            if ($frame) {
                $frame.open();
                return;
            }

            // Create the media frame.
            $frame = wp.media.frames.downloadable_file = wp.media({
                title: 'Select an  Image',
                button: {
                    text: 'Add Image'
                },
                multiple: false
            });

            // When an image is selected, run a callback.
            $frame.on('select', function () {
                var $selection = $frame.state().get('selection');
                $selection.map(function ($attachment) {
                    $attachment = $attachment.toJSON();
                    if ($attachment.id) {
                        //$id = $id ? $id + "," + $attachment.id : $attachment.id;
                        $id = $attachment.id;
                        var $url = $attachment.url;
                        if ($attachment.sizes.thumbnail) $url = $attachment.sizes.thumbnail.url;
                        $preview.html('<img src="' + $url + '" /><br /><a href="#">Delete</a>');
                    }
                });
                $field.val($id);

            });
            $frame.on('close', function () {
                $('.ui-widget-overlay').show();
                $this.parents('.shortcode-dialog').show();
            });
            
            // Finally, open the modal.
            $frame.open();
            
        });
    });
}