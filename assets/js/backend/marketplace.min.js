jQuery(document).ready(function ($) {
    
    var $doc = $(document);

    $(window).bind('tb_unload', function () {
        $('.super-add-item > *:not(.super-msg)').show();
        $('.super-add-item .super-msg').html('').removeClass('super-error').removeClass('super-success');
    });

    $doc.on('click', '.super-marketplace .purchase-now', function(){
        var $this = $(this);
        if(!$this.hasClass('button-disabled')){
            var $old_html = $this.html();
            $this.html('Loading...').addClass('button-disabled');
            var $id = $this.parents('.plugin-card:eq(0)').data('id');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_marketplace_purchase_item',
                    item: $id
                },
                success: function (result) {
                    window.location.href = "https://f4d.nl/super-forms/?api=marketplace-purchase-item&item="+$id+"&user="+result+"&return-url="+window.location.href;
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    $this.html($old_html);
                    alert(super_marketplace_i18n.connection_lost);
                }
            });
        }
    });
    

    $doc.on('click', '.super-marketplace .install-now', function(){
        var $this = $(this);
        if(!$this.hasClass('button-disabled')){
            var $old_html = $this.html();
            $this.html('Installing...').addClass('button-disabled');
            var $id = $this.parents('.plugin-card:eq(0)').data('id');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_marketplace_install_item',
                    item: $id
                },
                success: function (result) {
                    var $result = jQuery.parseJSON(result);
                    if($result.error!=false){
                        alert($result.msg);
                    }else{
                        window.location.href = "admin.php?page=super_create_form&id="+$result.id;
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(super_marketplace_i18n.connection_lost);
                }
            });
        }
    });

    $doc.on('click', '.super-add-item .super-submit', function(){
        var $this = $(this);
        var $old_html = $this.html();
        var $error = false;
        
        $('.super-add-item label').removeClass('error');
        var $field = $('select[name="forms"]');
        if($field.val()==''){
            $error = true;
            $field.parents('label:eq(0)').addClass('error');
        }
        var $field = $('input[name="price"]');
        if($field.val()>10){
            $error = true;
            $field.parents('label:eq(0)').addClass('error');
        }
        if($('input[name="price"]').val()>0){
            var $field = $('input[name="paypal"]');
            if (($field.val().length < 4) || (!/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/.test($field.val()))) {
                $error = true;
                $field.parents('label:eq(0)').addClass('error');
            }
        }
        var $field = $('input[name="email"]');
        if (($field.val().length < 4) || (!/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/.test($field.val()))) {
            $error = true;
            $field.parents('label:eq(0)').addClass('error');
        }

        if($error==false){
            var $form = $('select[name="forms"]').val();
            var $price = $('input[name="price"]').val();
            var $paypal = $('input[name="paypal"]').val();
            var $email = $('input[name="email"]').val();
            $this.html('Loading...');
            $.ajax({
                type: 'post',
                url: ajaxurl,
                data: {
                    action: 'super_marketplace_add_item',
                    form: $form,
                    price: $price,
                    paypal: $paypal,
                    email: $email
                },
                success: function (result) {
                    var $result = jQuery.parseJSON(result);
                    var $msg = $('.super-add-item .super-msg');
                    if($result.error==true){
                        $msg.removeClass('super-success').addClass('super-error').html($result.msg);
                    }else{
                        $('.super-add-item > *:not(.super-msg)').hide();
                        $msg.removeClass('super-error').addClass('super-success').html($result.msg);
                    }
                },
                complete: function(){
                    $this.html($old_html);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(super_marketplace_i18n.connection_lost);
                }
            });
        }

    });

    $doc.on('click', '.report', function(){
        var $this = $(this);
        if(!$this.hasClass('reported')){
            var $reason = prompt(super_marketplace_i18n.reason+':', '');
            if($reason.length > 2){
                var $id = $this.parents('.plugin-card:eq(0)').data('id');
                $.ajax({
                    type: 'post',
                    url: ajaxurl,
                    data: {
                        action: 'super_marketplace_report_abuse',
                        id: $id,
                        reason: $reason
                    },
                    success: function (result) {
                        $this.addClass('reported').html('Reported!');
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(super_marketplace_i18n.connection_lost);
                    }
                });
            }else{
                alert(super_marketplace_i18n.reason_empty);
            }
        }
    });

});